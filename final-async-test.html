<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Final Async Test</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				margin: 20px;
			}
			.test {
				border: 1px solid #ccc;
				margin: 10px 0;
				padding: 10px;
			}
			.loading {
				background: lightblue;
				padding: 10px;
			}
			.result {
				background: lightgreen;
				padding: 10px;
			}
			.error {
				background: lightcoral;
				padding: 10px;
			}
			button {
				padding: 10px;
				margin: 5px;
			}
		</style>
	</head>
	<body>
		<h1>Final Async Test</h1>

		<!-- Test 1: Basic data-await with data-then -->
		<div class="test">
			<h3>Test 1: Basic Async</h3>
			<div data-await="@userPromise" class="loading">
				Loading user data...
			</div>
			<div data-then="user" class="result">
				<h4>User: ${user.name}</h4>
				<p>Email: ${user.email}</p>
				<p>Role: ${user.role}</p>
			</div>
			<div data-else class="error">Failed to load user data</div>
			<button onclick="loadUser()">Load User</button>
		</div>

		<!-- Test 2: Button with async processing -->
		<div class="test">
			<h3>Test 2: Button with Processing</h3>
			<button
				data-bind="onclick: @fetchData"
				data-process="onclick: response => response.json()"
				data-then="data"
			>
				Fetch JSON Data
			</button>
			<div data-then="data" class="result">
				<h4>Fetched Data:</h4>
				<p>Message: ${data.message}</p>
				<p>Timestamp: ${data.timestamp}</p>
			</div>
		</div>

		<!-- Test 3: HTMx-style targeting -->
		<div class="test">
			<h3>Test 3: HTMx-style Targeting</h3>
			<div id="content-area" class="result">
				<p>Default content - click button to update</p>
			</div>
			<button
				data-bind="onclick: @fetchHtml"
				data-process="onclick: response => response.text()"
				data-target="onclick: #content-area"
			>
				Update Content
			</button>
		</div>

		<script type="module">
			import "./src/index.js";
			import { State } from "./src/State.js";

			// Test 1: User data promise
			let userPromise = new State(null);
			State.register("userPromise", userPromise);

			window.loadUser = () => {
				console.log("Loading user...");
				const promise = new Promise((resolve, reject) => {
					setTimeout(() => {
						if (Math.random() > 0.2) {
							// 80% success rate
							resolve({
								name: "John Doe",
								email: "john@example.com",
								role: "Developer",
							});
						} else {
							reject(new Error("Failed to fetch user"));
						}
					}, 2000);
				});
				userPromise.value = promise;
			};

			// Test 2: Fetch data function
			const fetchData = new State(() => {
				console.log("Fetching data...");
				return new Promise((resolve) => {
					setTimeout(() => {
						const mockResponse = {
							json: () =>
								Promise.resolve({
									message: "Hello from API!",
									timestamp: new Date().toISOString(),
								}),
						};
						resolve(mockResponse);
					}, 1500);
				});
			});
			State.register("fetchData", fetchData);

			// Test 3: Fetch HTML content
			const fetchHtml = new State(() => {
				console.log("Fetching HTML...");
				return new Promise((resolve) => {
					setTimeout(() => {
						const mockResponse = {
							text: () =>
								Promise.resolve(`
                            <h4>Updated Content!</h4>
                            <p>This content was loaded at ${new Date().toLocaleTimeString()}</p>
                            <p>Random number: ${Math.floor(
								Math.random() * 1000
							)}</p>
                        `),
						};
						resolve(mockResponse);
					}, 1000);
				});
			});
			State.register("fetchHtml", fetchHtml);

			console.log("Final async test setup complete");
		</script>
	</body>
</html>
