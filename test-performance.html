<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Manifold Performance Testing</title>
		<style>
			body {
				font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
				max-width: 1200px;
				margin: 0 auto;
				padding: 20px;
				background: #f5f5f5;
			}

			.header {
				text-align: center;
				margin-bottom: 30px;
			}

			.test-section {
				background: white;
				border-radius: 8px;
				padding: 20px;
				margin-bottom: 20px;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
			}

			.test-controls {
				display: flex;
				gap: 10px;
				margin-bottom: 15px;
				flex-wrap: wrap;
			}

			.test-button {
				padding: 8px 16px;
				background: #007acc;
				color: white;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				font-size: 14px;
			}

			.test-button:hover {
				background: #005a9e;
			}

			.test-button:disabled {
				background: #ccc;
				cursor: not-allowed;
			}

			.metrics {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 15px;
				margin-bottom: 20px;
			}

			.metric {
				background: #f8f9fa;
				padding: 15px;
				border-radius: 6px;
				text-align: center;
			}

			.metric-value {
				font-size: 24px;
				font-weight: bold;
				color: #007acc;
				margin-bottom: 5px;
			}

			.metric-label {
				font-size: 12px;
				color: #666;
				text-transform: uppercase;
			}

			.test-output {
				background: #f8f9fa;
				border: 1px solid #e9ecef;
				border-radius: 4px;
				padding: 15px;
				min-height: 100px;
				font-family: monospace;
				font-size: 12px;
				white-space: pre-wrap;
				overflow-y: auto;
				max-height: 300px;
			}

			.performance-chart {
				height: 200px;
				background: #f8f9fa;
				border-radius: 4px;
				position: relative;
				overflow: hidden;
				margin-top: 15px;
			}

			.chart-bar {
				position: absolute;
				bottom: 0;
				background: linear-gradient(to top, #007acc, #4da6d9);
				width: 4px;
				border-radius: 2px 2px 0 0;
				transition: height 0.3s ease;
			}

			.stress-test-area {
				border: 2px dashed #ddd;
				padding: 20px;
				min-height: 100px;
				border-radius: 8px;
				background: #fafafa;
			}

			.item {
				display: inline-block;
				padding: 4px 8px;
				margin: 2px;
				background: #e3f2fd;
				border-radius: 4px;
				font-size: 12px;
			}

			.log-entry {
				margin-bottom: 5px;
				padding: 5px;
				border-left: 3px solid #007acc;
				background: #f0f8ff;
			}

			.log-time {
				color: #666;
				font-size: 11px;
			}

			.warning {
				background: #fff3cd;
				border-left-color: #ffc107;
			}

			.error {
				background: #f8d7da;
				border-left-color: #dc3545;
			}

			.success {
				background: #d4edda;
				border-left-color: #28a745;
			}
		</style>
	</head>
	<body>
		<div class="header">
			<h1>Manifold Performance Testing Suite</h1>
			<p>Real-time performance analysis and benchmarking</p>
		</div>

		<!-- State Reactivity Tests -->
		<div class="test-section">
			<h2>State Reactivity Performance</h2>
			<div class="test-controls">
				<button class="test-button" id="test-rapid-updates">
					Rapid Updates Test
				</button>
				<button class="test-button" id="test-batch-updates">
					Batch Updates Test
				</button>
				<button class="test-button" id="test-complex-state">
					Complex State Test
				</button>
				<button class="test-button" id="clear-reactivity">Clear</button>
			</div>

			<div class="metrics">
				<div class="metric">
					<div
						class="metric-value"
						data-bind="textContent: @reactivityTime || '0'"
					>
						0
					</div>
					<div class="metric-label">Time (ms)</div>
				</div>
				<div class="metric">
					<div
						class="metric-value"
						data-bind="textContent: @reactivityUpdates || '0'"
					>
						0
					</div>
					<div class="metric-label">Updates/sec</div>
				</div>
				<div class="metric">
					<div
						class="metric-value"
						data-bind="textContent: @reactivityMemory || '0'"
					>
						0
					</div>
					<div class="metric-label">Memory (KB)</div>
				</div>
			</div>

			<div class="test-output" id="reactivity-output"></div>
			<div class="performance-chart" id="reactivity-chart"></div>
		</div>

		<!-- DOM Binding Performance -->
		<div class="test-section">
			<h2>DOM Binding Performance</h2>
			<div class="test-controls">
				<button class="test-button" id="test-dom-updates">
					DOM Updates Test
				</button>
				<button class="test-button" id="test-complex-bindings">
					Complex Bindings Test
				</button>
				<button class="test-button" id="test-many-elements">
					Many Elements Test
				</button>
				<button class="test-button" id="clear-dom">Clear</button>
			</div>

			<div class="metrics">
				<div class="metric">
					<div
						class="metric-value"
						data-bind="textContent: @domTime || '0'"
					>
						0
					</div>
					<div class="metric-label">Time (ms)</div>
				</div>
				<div class="metric">
					<div
						class="metric-value"
						data-bind="textContent: @domElements || '0'"
					>
						0
					</div>
					<div class="metric-label">Elements</div>
				</div>
				<div class="metric">
					<div
						class="metric-value"
						data-bind="textContent: @domThroughput || '0'"
					>
						0
					</div>
					<div class="metric-label">Updates/sec</div>
				</div>
			</div>

			<div class="stress-test-area" id="dom-test-area"></div>
			<div class="test-output" id="dom-output"></div>
		</div>

		<!-- Each-Loop Performance -->
		<div class="test-section">
			<h2>Each-Loop Performance</h2>
			<div class="test-controls">
				<button class="test-button" id="test-large-array">
					Large Array Test
				</button>
				<button class="test-button" id="test-array-updates">
					Array Updates Test
				</button>
				<button class="test-button" id="test-array-modifications">
					Array Modifications Test
				</button>
				<button class="test-button" id="clear-each">Clear</button>
			</div>

			<div class="metrics">
				<div class="metric">
					<div
						class="metric-value"
						data-bind="textContent: @eachTime || '0'"
					>
						0
					</div>
					<div class="metric-label">Time (ms)</div>
				</div>
				<div class="metric">
					<div
						class="metric-value"
						data-bind="textContent: @eachItems || '0'"
					>
						0
					</div>
					<div class="metric-label">Items</div>
				</div>
				<div class="metric">
					<div
						class="metric-value"
						data-bind="textContent: @eachDomOps || '0'"
					>
						0
					</div>
					<div class="metric-label">DOM Ops</div>
				</div>
			</div>

			<div class="stress-test-area" id="each-test-area"></div>
			<div class="test-output" id="each-output"></div>
		</div>

		<!-- Expression Parsing Performance -->
		<div class="test-section">
			<h2>Expression Parsing Performance</h2>
			<div class="test-controls">
				<button class="test-button" id="test-simple-expressions">
					Simple Expressions
				</button>
				<button class="test-button" id="test-complex-expressions">
					Complex Expressions
				</button>
				<button class="test-button" id="test-parsing-benchmark">
					Parsing Benchmark
				</button>
				<button class="test-button" id="clear-parsing">Clear</button>
			</div>

			<div class="metrics">
				<div class="metric">
					<div
						class="metric-value"
						data-bind="textContent: @parsingTime || '0'"
					>
						0
					</div>
					<div class="metric-label">Time (ms)</div>
				</div>
				<div class="metric">
					<div
						class="metric-value"
						data-bind="textContent: @parsingCount || '0'"
					>
						0
					</div>
					<div class="metric-label">Expressions</div>
				</div>
				<div class="metric">
					<div
						class="metric-value"
						data-bind="textContent: @parsingRate || '0'"
					>
						0
					</div>
					<div class="metric-label">Expr/sec</div>
				</div>
			</div>

			<div class="test-output" id="parsing-output"></div>
		</div>

		<!-- Memory Usage -->
		<div class="test-section">
			<h2>Memory Usage Analysis</h2>
			<div class="test-controls">
				<button class="test-button" id="test-memory-leaks">
					Memory Leak Test
				</button>
				<button class="test-button" id="test-cleanup">
					Cleanup Test
				</button>
				<button class="test-button" id="force-gc">Force GC</button>
				<button class="test-button" id="clear-memory">Clear</button>
			</div>

			<div class="metrics">
				<div class="metric">
					<div
						class="metric-value"
						data-bind="textContent: @memoryUsed || '0'"
					>
						0
					</div>
					<div class="metric-label">Used (KB)</div>
				</div>
				<div class="metric">
					<div
						class="metric-value"
						data-bind="textContent: @memoryTotal || '0'"
					>
						0
					</div>
					<div class="metric-label">Total (KB)</div>
				</div>
				<div class="metric">
					<div
						class="metric-value"
						data-bind="textContent: @memoryGrowth || '0'"
					>
						0
					</div>
					<div class="metric-label">Growth (KB)</div>
				</div>
			</div>

			<div class="test-output" id="memory-output"></div>
			<div class="performance-chart" id="memory-chart"></div>
		</div>

		<!-- Overall Benchmark -->
		<div class="test-section">
			<h2>Overall Performance Benchmark</h2>
			<div class="test-controls">
				<button class="test-button" id="run-full-benchmark">
					Run Full Benchmark
				</button>
				<button class="test-button" id="run-comparison">
					Compare with Vanilla JS
				</button>
				<button class="test-button" id="export-results">
					Export Results
				</button>
			</div>

			<div class="metrics">
				<div class="metric">
					<div
						class="metric-value"
						data-bind="textContent: @overallScore || '0'"
					>
						0
					</div>
					<div class="metric-label">Performance Score</div>
				</div>
				<div class="metric">
					<div
						class="metric-value"
						data-bind="textContent: @benchmarkTime || '0'"
					>
						0
					</div>
					<div class="metric-label">Total Time (ms)</div>
				</div>
				<div class="metric">
					<div
						class="metric-value"
						data-bind="textContent: @benchmarkStatus || 'Ready'"
					>
						Ready
					</div>
					<div class="metric-label">Status</div>
				</div>
			</div>

			<div class="test-output" id="benchmark-output"></div>
		</div>

		<script src="./dist/manifold.umd.js"></script>
		<script type="module">
			const { State, RegEl } = window.Manifold;

			// Performance metrics states
			const reactivityTime = new State(0);
			const reactivityUpdates = new State(0);
			const reactivityMemory = new State(0);

			const domTime = new State(0);
			const domElements = new State(0);
			const domThroughput = new State(0);

			const eachTime = new State(0);
			const eachItems = new State(0);
			const eachDomOps = new State(0);

			const parsingTime = new State(0);
			const parsingCount = new State(0);
			const parsingRate = new State(0);

			const memoryUsed = new State(0);
			const memoryTotal = new State(0);
			const memoryGrowth = new State(0);

			const overallScore = new State(0);
			const benchmarkTime = new State(0);
			const benchmarkStatus = new State("Ready");

			// Register all states
			State.register("reactivityTime", reactivityTime);
			State.register("reactivityUpdates", reactivityUpdates);
			State.register("reactivityMemory", reactivityMemory);
			State.register("domTime", domTime);
			State.register("domElements", domElements);
			State.register("domThroughput", domThroughput);
			State.register("eachTime", eachTime);
			State.register("eachItems", eachItems);
			State.register("eachDomOps", eachDomOps);
			State.register("parsingTime", parsingTime);
			State.register("parsingCount", parsingCount);
			State.register("parsingRate", parsingRate);
			State.register("memoryUsed", memoryUsed);
			State.register("memoryTotal", memoryTotal);
			State.register("memoryGrowth", memoryGrowth);
			State.register("overallScore", overallScore);
			State.register("benchmarkTime", benchmarkTime);
			State.register("benchmarkStatus", benchmarkStatus);

			// Initialize all elements
			document
				.querySelectorAll("[data-bind], [data-each]")
				.forEach((el) => {
					RegEl.register(el);
				});

			// Utility functions
			const measureTime = async (fn) => {
				const start = performance.now();
				await fn();
				return performance.now() - start;
			};

			const getMemoryUsage = () => {
				if ("memory" in performance) {
					return {
						used: Math.round(
							performance.memory.usedJSHeapSize / 1024
						),
						total: Math.round(
							performance.memory.totalJSHeapSize / 1024
						),
					};
				}
				return { used: 0, total: 0 };
			};

			const logToOutput = (outputId, message, type = "info") => {
				const output = document.getElementById(outputId);
				const time = new Date().toLocaleTimeString();
				const entry = document.createElement("div");
				entry.className = `log-entry ${type}`;
				entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
				output.appendChild(entry);
				output.scrollTop = output.scrollHeight;
			};

			const clearOutput = (outputId) => {
				document.getElementById(outputId).innerHTML = "";
			};

			// Update memory display
			const updateMemoryDisplay = () => {
				const memory = getMemoryUsage();
				memoryUsed.value = memory.used;
				memoryTotal.value = memory.total;
			};

			// Update memory display every second
			setInterval(updateMemoryDisplay, 1000);
			updateMemoryDisplay();

			// Reactivity Tests
			document
				.getElementById("test-rapid-updates")
				.addEventListener("click", async () => {
					logToOutput(
						"reactivity-output",
						"Starting rapid updates test...",
						"info"
					);

					const testState = new State(0);
					let updateCount = 0;

					const cleanup = testState.effect(() => {
						updateCount++;
					});

					const time = await measureTime(() => {
						for (let i = 0; i < 1000; i++) {
							testState.value = i;
						}
					});

					cleanup();

					reactivityTime.value = Math.round(time * 100) / 100;
					reactivityUpdates.value = Math.round(1000 / (time / 1000));

					const memory = getMemoryUsage();
					reactivityMemory.value = memory.used;

					logToOutput(
						"reactivity-output",
						`Completed 1000 updates in ${time.toFixed(2)}ms`,
						"success"
					);
					logToOutput(
						"reactivity-output",
						`Average: ${(time / 1000).toFixed(4)}ms per update`,
						"info"
					);
				});

			document
				.getElementById("test-batch-updates")
				.addEventListener("click", async () => {
					logToOutput(
						"reactivity-output",
						"Starting batch updates test...",
						"info"
					);

					const state1 = new State(0);
					const state2 = new State(0);
					const computed = new State(
						() => state1.value + state2.value
					);

					let computedCalls = 0;
					const cleanup = computed.effect(() => {
						computedCalls++;
						computed.value; // Trigger computation
					});

					const time = await measureTime(() => {
						for (let i = 0; i < 100; i++) {
							state1.value = i;
							state2.value = i * 2;
						}
					});

					cleanup();

					reactivityTime.value = Math.round(time * 100) / 100;
					reactivityUpdates.value = computedCalls;

					logToOutput(
						"reactivity-output",
						`Batch updates completed in ${time.toFixed(2)}ms`,
						"success"
					);
					logToOutput(
						"reactivity-output",
						`Computed function called ${computedCalls} times`,
						"info"
					);
				});

			document
				.getElementById("clear-reactivity")
				.addEventListener("click", () => {
					clearOutput("reactivity-output");
					reactivityTime.value = 0;
					reactivityUpdates.value = 0;
					reactivityMemory.value = 0;
				});

			// DOM Tests
			document
				.getElementById("test-dom-updates")
				.addEventListener("click", async () => {
					logToOutput(
						"dom-output",
						"Starting DOM updates test...",
						"info"
					);

					const testArea = document.getElementById("dom-test-area");
					testArea.innerHTML = "";

					const testState = new State("initial");
					State.register("domTestState", testState);

					// Create multiple elements
					const elements = [];
					for (let i = 0; i < 100; i++) {
						const div = document.createElement("div");
						div.className = "item";
						div.dataset.bind =
							'textContent: @domTestState + " " + ' + i;
						testArea.appendChild(div);
						RegEl.register(div);
						elements.push(div);
					}

					domElements.value = elements.length;

					const time = await measureTime(() => {
						for (let i = 0; i < 50; i++) {
							testState.value = `Update ${i}`;
						}
					});

					domTime.value = Math.round(time * 100) / 100;
					domThroughput.value = Math.round(
						(50 * 100) / (time / 1000)
					);

					logToOutput(
						"dom-output",
						`Updated ${
							elements.length
						} elements 50 times in ${time.toFixed(2)}ms`,
						"success"
					);
					logToOutput(
						"dom-output",
						`Throughput: ${domThroughput.value} updates/sec`,
						"info"
					);
				});

			document
				.getElementById("clear-dom")
				.addEventListener("click", () => {
					clearOutput("dom-output");
					document.getElementById("dom-test-area").innerHTML = "";
					domTime.value = 0;
					domElements.value = 0;
					domThroughput.value = 0;
				});

			// Add more test implementations...
			// Each-loop tests, parsing tests, memory tests, etc.

			document
				.getElementById("run-full-benchmark")
				.addEventListener("click", async () => {
					benchmarkStatus.value = "Running...";
					logToOutput(
						"benchmark-output",
						"Starting full performance benchmark...",
						"info"
					);

					const startTime = performance.now();

					// Run all tests sequentially
					// This would include all the individual test functions

					const totalTime = performance.now() - startTime;
					benchmarkTime.value = Math.round(totalTime);

					// Calculate performance score based on results
					const score = Math.max(0, 100 - totalTime / 100);
					overallScore.value = Math.round(score);

					benchmarkStatus.value = "Complete";
					logToOutput(
						"benchmark-output",
						`Full benchmark completed in ${totalTime.toFixed(2)}ms`,
						"success"
					);
					logToOutput(
						"benchmark-output",
						`Performance Score: ${score.toFixed(1)}/100`,
						"info"
					);
				});
		</script>
	</body>
</html>
