<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Manifold Debug - Registration vs DOM Effects</title>
		<style>
			body {
				font-family: system-ui, sans-serif;
				max-width: 1000px;
				margin: 0 auto;
				padding: 2rem;
			}
			.test-section {
				margin: 2rem 0;
				padding: 1rem;
				border: 2px solid #ddd;
				border-radius: 8px;
			}
			.pass {
				border-color: #28a745;
				background: #d4edda;
			}
			.fail {
				border-color: #dc3545;
				background: #f8d7da;
			}
			.warn {
				border-color: #ffc107;
				background: #fff3cd;
			}
			button {
				padding: 8px 16px;
				margin: 4px;
				background: #007acc;
				color: white;
				border: none;
				border-radius: 4px;
				cursor: pointer;
			}
			.debug {
				background: #f8f9fa;
				padding: 1rem;
				margin: 1rem 0;
				border-radius: 4px;
				font-family: monospace;
			}
			.log {
				margin: 0.5rem 0;
				padding: 0.25rem;
				background: white;
				border-left: 3px solid #007acc;
			}
		</style>
	</head>
	<body>
		<h1>üîç Manifold Debug: Registration vs DOM Effects</h1>

		<div class="test-section" id="test1">
			<h3>Test 1: Direct DOM Manipulation (Control)</h3>
			<p>
				This tests if our reactive system can update DOM elements
				directly (bypassing registration)
			</p>
			<div>Counter: <span id="direct-counter">0</span></div>
			<button id="direct-increment">Direct Increment</button>
			<div class="debug" id="test1-log"></div>
		</div>

		<div class="test-section" id="test2">
			<h3>Test 2: Registration Process Investigation</h3>
			<p>
				Let's see what happens when we register an element with
				expressions
			</p>
			<div id="registration-target">
				<p>User: ${user.name}</p>
				<p>Counter: ${counter}</p>
			</div>
			<button id="trigger-registration">Register Element</button>
			<div class="debug" id="test2-log"></div>
		</div>

		<div class="test-section" id="test3">
			<h3>Test 3: Expression Parser Integration</h3>
			<p>Test if expressions are being parsed and bound correctly</p>
			<div id="expression-target">
				<span>${user.name}</span> is <span>${user.age}</span> years old
			</div>
			<button id="test-expressions">Test Expressions</button>
			<div class="debug" id="test3-log"></div>
		</div>

		<div class="test-section" id="test4">
			<h3>Test 4: data-mf-register Auto-Registration</h3>
			<p>Test if the auto-registration system works</p>
			<div data-mf-register id="auto-register-target">
				<p>Name: ${user.name}</p>
				<p>Age: ${user.age}</p>
				<button onclick="${() => user.name = 'Updated!'}">
					Update Name
				</button>
			</div>
			<div class="debug" id="test4-log"></div>
		</div>

		<div class="test-section" id="test5">
			<h3>Test 5: Conditional Rendering Investigation</h3>
			<p>Test if data-if attributes are processed</p>
			<div id="conditional-target">
				<div data-if="${counter > 5}">Counter is greater than 5!</div>
				<div data-else>Counter is 5 or less</div>
			</div>
			<button id="test-conditionals">Register & Test Conditionals</button>
			<div class="debug" id="test5-log"></div>
		</div>

		<script type="module">
			import { state, register } from "./src/index.js";
			import _evaluateExpression from "./src/expression-parser.js";

			// Global states
			window.user = state({ name: "John Doe", age: 25 });
			window.counter = state(0);

			// Logging helper
			function log(testId, message, type = "info") {
				const logElement = document.getElementById(`${testId}-log`);
				const logEntry = document.createElement("div");
				logEntry.className = "log";
				logEntry.style.borderLeftColor =
					type === "error"
						? "#dc3545"
						: type === "success"
						? "#28a745"
						: "#007acc";
				logEntry.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
				logElement.appendChild(logEntry);
				console.log(`[${testId}]`, message);
			}

			function markTest(testId, status) {
				const section = document.getElementById(testId);
				section.className = `test-section ${status}`;
			}

			// Test 1: Direct DOM manipulation (control test)
			document.getElementById("direct-increment").onclick = () => {
				window.counter.value++;
				log(
					"test1",
					`Counter incremented to ${window.counter.value}`,
					"info"
				);
			};

			// Set up direct DOM binding
			const directCounterSpan = document.getElementById("direct-counter");
			window.counter.effect((value) => {
				directCounterSpan.textContent = value;
				log("test1", `Direct DOM updated to: ${value}`, "success");
			});

			log("test1", "Direct DOM binding established", "success");
			markTest("test1", "pass");

			// Test 2: Registration process investigation
			document.getElementById("trigger-registration").onclick = () => {
				const target = document.getElementById("registration-target");
				log(
					"test2",
					`Attempting to register element: ${target.tagName}`,
					"info"
				);
				log("test2", `Element innerHTML: ${target.innerHTML}`, "info");

				try {
					const regEl = register(target);
					log("test2", `Registration returned: ${regEl}`, "success");
					log("test2", `RegEl type: ${typeof regEl}`, "info");
					log(
						"test2",
						`RegEl constructor: ${regEl?.constructor?.name}`,
						"info"
					);

					// Check if RegEl has expected properties
					if (regEl) {
						log(
							"test2",
							`RegEl._props: ${JSON.stringify(
								Object.keys(regEl._props || {})
							)}`,
							"info"
						);
						log("test2", `RegEl._show: ${regEl._show}`, "info");
						log("test2", `RegEl._each: ${regEl._each}`, "info");

						// Try to trigger state updates
						setTimeout(() => {
							window.user.value = {
								...window.user.value,
								name: "Updated User",
							};
							window.counter.value += 10;
							log(
								"test2",
								"State updated, checking if DOM reflects changes...",
								"info"
							);

							setTimeout(() => {
								log(
									"test2",
									`Current element innerHTML: ${target.innerHTML}`,
									"info"
								);
							}, 100);
						}, 500);
					}

					markTest("test2", "pass");
				} catch (error) {
					log(
						"test2",
						`Registration failed: ${error.message}`,
						"error"
					);
					log("test2", `Stack: ${error.stack}`, "error");
					markTest("test2", "fail");
				}
			};

			// Test 3: Expression parser integration
			document.getElementById("test-expressions").onclick = () => {
				const target = document.getElementById("expression-target");
				log(
					"test3",
					"Testing expression parser integration...",
					"info"
				);

				// Test expression parsing directly
				try {
					const expr1 = "user.name";
					const result1 = _evaluateExpression(expr1);
					log(
						"test3",
						`Expression "${expr1}" parsed successfully`,
						"success"
					);
					log(
						"test3",
						`Result function: ${typeof result1.fn}`,
						"info"
					);
					log(
						"test3",
						`State refs: ${result1._stateRefs?.size || 0}`,
						"info"
					);

					// Test function execution
					const testValue = result1.fn({ user: window.user.value });
					log(
						"test3",
						`Expression result: "${testValue}"`,
						"success"
					);

					// Now try with registration
					log(
						"test3",
						"Attempting to register expression element...",
						"info"
					);
					const regEl = register(target);

					if (regEl) {
						log(
							"test3",
							"Expression element registered",
							"success"
						);
						window.user.value = {
							...window.user.value,
							name: "Expression Test",
						};
						markTest("test3", "pass");
					} else {
						log(
							"test3",
							"Registration returned null/undefined",
							"error"
						);
						markTest("test3", "fail");
					}
				} catch (error) {
					log(
						"test3",
						`Expression test failed: ${error.message}`,
						"error"
					);
					markTest("test3", "fail");
				}
			};

			// Test 4: Auto-registration investigation
			document.addEventListener("DOMContentLoaded", () => {
				log(
					"test4",
					"DOM loaded, checking for auto-registration...",
					"info"
				);

				const autoTarget = document.getElementById(
					"auto-register-target"
				);
				log(
					"test4",
					`Auto-register target found: ${!!autoTarget}`,
					"info"
				);
				log(
					"test4",
					`Has data-mf-register: ${autoTarget?.hasAttribute(
						"data-mf-register"
					)}`,
					"info"
				);

				// Check if any auto-registration happened
				const registeredElements =
					document.querySelectorAll("[data-mf-register]");
				log(
					"test4",
					`Found ${registeredElements.length} elements with data-mf-register`,
					"info"
				);

				if (registeredElements.length > 0) {
					log(
						"test4",
						"Attempting manual registration of data-mf-register elements...",
						"info"
					);
					registeredElements.forEach((el, index) => {
						try {
							const regEl = register(el);
							log(
								"test4",
								`Element ${index} registered: ${!!regEl}`,
								regEl ? "success" : "error"
							);
						} catch (error) {
							log(
								"test4",
								`Element ${index} registration failed: ${error.message}`,
								"error"
							);
						}
					});
				}

				// Test state updates
				setTimeout(() => {
					window.user.value = {
						...window.user.value,
						name: "Auto-Register Test",
					};
					log(
						"test4",
						"State updated for auto-register test",
						"info"
					);
				}, 1000);
			});

			// Test 5: Conditional rendering
			document.getElementById("test-conditionals").onclick = () => {
				const target = document.getElementById("conditional-target");
				log("test5", "Testing conditional rendering...", "info");
				log(
					"test5",
					`Target children: ${target.children.length}`,
					"info"
				);

				try {
					// Register each child element that has data attributes
					Array.from(target.children).forEach((child, index) => {
						if (
							child.hasAttribute("data-if") ||
							child.hasAttribute("data-else")
						) {
							log(
								"test5",
								`Registering conditional element ${index}: ${
									child.getAttribute("data-if") || "data-else"
								}`,
								"info"
							);
							const regEl = register(child);
							log(
								"test5",
								`Conditional element ${index} registered: ${!!regEl}`,
								regEl ? "success" : "error"
							);

							if (regEl) {
								log(
									"test5",
									`Element ${index} _show state: ${regEl._show}`,
									"info"
								);
							}
						}
					});

					// Test different counter values
					log("test5", "Testing counter values...", "info");
					[3, 7, 1, 10].forEach((value, index) => {
						setTimeout(() => {
							window.counter.value = value;
							log("test5", `Set counter to ${value}`, "info");
						}, (index + 1) * 1000);
					});

					markTest("test5", "warn");
				} catch (error) {
					log(
						"test5",
						`Conditional test failed: ${error.message}`,
						"error"
					);
					markTest("test5", "fail");
				}
			};

			log("test1", "All tests initialized", "success");
		</script>
	</body>
</html>
