let t=[],e=0,s=[],i=s=>{t.push(s),e||(e=requestAnimationFrame(n))},n=()=>{e=0;for(let e of t)if("function"!=typeof e){if("prepend"==e.relation)e.in.t("in",(()=>e.in&&e.out?.i(e.in.o,"prepend",!1)));else{if(["inner","outer"].includes(e.relation)){let t=e.out?.i(e.out?.o,"after");"inner"==e.relation&&(t.style.border="none",e?.out?.l()),e.out.t("out")}e.in.t("in",(()=>{"outer"==e.relation?e.out?.h(e.in):e.out?.i(e.in.o,"appendChild",!1)}))}e.done?.(e.in)}else e();s.forEach((t=>t())),s=[],t=[]},o="mf_",r=/, {0,}/g,l=()=>`${Date.now()}.${Math.floor(1e5*Math.random())}`,a=(t,e)=>{let s=t.profiles?.[e.u("override")||""],i={...t,...s};for(let t in e.p())for(let s of["fetch","trans"])if(t.startsWith(`${o}${s}_`))try{let n=t.split("_")[2],o=e.u(t);o?.match(/\{|\[/)?o=JSON.parse(o):parseInt(o||"")&&(o=parseInt(o)),Array.isArray(o)&&(o=o.map((t=>parseInt(t)||t))),i[s][n]=o}catch(t){console.error(t)}return i},h=(t,e="$val",s="$key")=>{try{let[i,n]=t?.split(/\s{1,}as\s{1,}/)||[t,"value"],o=`let {$el, $st, $fn, ${e}, ${s}, $body} = ops;return ${i?.match(/^\s{0,}(function)?\(.{0,}\)(=>)?\s{0,}/)?`(${i})()`:i}`,l=n?.split?.(r)?.map?.((t=>t.trim()))||["value"]||[];return console.log("FN TEXT",o,l,t),{func:new Function("ops",o),as:l}}catch(t){return console.error(t),{}}};function u(t,e,s){e?.preventDefault();let i=t?.u("pushstate"),n=s;switch(i){case"":break;case void 0:return;default:n=`#${i}`}history.pushState(null,"",n)}function c(t){if(!t)return 0;if("number"==typeof t||!0===t)return t;if(t instanceof Map||t instanceof Set)return c(Array.from(t.entries()||t));let e=0;for(let s of(new TextEncoder).encode(t?.toString()||""))e=(e<<5)-e+s;return e}class f{$;m=new Map;_;M=new Set;T=new Set;v;D;name;value;constructor(t,e){this.name=t,this.v="global",this.value=void 0,this.S(t,e)}S(t,e){return this.name=t,this.v=e?.scope||document.currentScript||"global",MFLD.st.set(t,this),e?.upstream?.map((t=>{let e=d(t);return this.M.add(e),e.T.add(this),e})),this.value=e?.value,this.$=e?.updater,this.F(),this}sub(t,e,s=!0){this.m.set(e||l(),t),s&&t(this.value)}update(t){this.D&&clearTimeout(this.D),this.D=setTimeout((()=>{i((()=>{let e="function"==typeof t?t(this.value):t,s=c(e);if(s!==this._){this.value=e,this._=s.toString();for(let t of this.T)t.F();for(let[t,e]of this.m)e(this.value,t)}return this.value}))}),0)}F(){let t=this.$?.(Array.from(this.M).map((t=>t.value))||[],this.value);this.update(void 0===t?this.value:t)}}function d(t,e){let s=MFLD.st.get(t);return e?s?s.S(t,e):new f(t,e):s||new f(t,e)}window.MFLD||(window.MFLD={st:new Map,mut:new Map,$st:new Proxy(d,{get:(t,e)=>"string"==typeof e?t(e)?.value:void 0,set:(t,e,s)=>{if("string"==typeof e){let i=e.split(/[\.\[\]\?]{1,}/g).map((t=>parseFloat(t.trim())||t.trim())),n=t(i[0]),o=n.value;for(let t of i.slice(1)||[])o=o[t];o=s,n.update(o)}return!0}}),$fn:{},comp:{}});let{$fn:p,$st:$}=MFLD,m=new WeakMap;class y{o;L=new Map;A=new Set;k;constructor(t){return t.element?this.o=t.element:t.query?this.o=(t.parent||document).querySelector(t.query):this.o=document.createElement(t.create||"TEMPLATE"),m.set(this.o,this),this.C(["_mfld",...t.classes||[]]),this.k=t.ops,this}p(){return this.o?.dataset||{}}u(t,e){e&&(this.o.dataset[`${o}${t}`]=e);let s=this.o?.dataset[`${o}${t}`];return s||void 0!==s?"T":""}C(t,e=!1){t instanceof Array&&(t=[t]);for(let s of t)this.o.classList[e?"remove":"add"]?.(s)}I(t,e=!0){return this.o["querySelector".concat(e?"All":"")](t)}N(t,e){return this.L?.set(t,e),e}G(t,e,s,i){return this.A?.add((()=>t({$el:this.o,$st:S,$fn:F,key:e,val:s,body:i}))),t}i(t,e="append",s=!0){let i=s?t.cloneNode(!0):t;return this.o[e]?.(i),i}l(){this.o.replaceChildren()}h(t){this.o?.replaceWith(t.o),this.O()}q(t=[]){let e=new y({classes:t,ops:this.k});return e.i(this.o),this.h(e),e}P(){let t=this.o,e=getComputedStyle(t),s=t.getBoundingClientRect();return{w:`calc(${t.clientWidth}px - ${e.paddingLeft} - ${e.paddingRight})`,left:`calc(${s.left}px + ${window.scrollX}px)`,top:`calc(${s.top}px + ${window.scrollY}px)`}}t(t,e,s){let n=this.k,r=n.trans?.dur?.["in"==t?"shift":"pop"]?.()||0;r&&(this.o.style.transitionDuration=`${r}ms`);let l=n?.trans?.class||`${o}trans`;n.trans?.hooks?.[`${t}-start`]?.(this.o),"out"==t?i((()=>{let t;this.C("out"),(n.trans?.smart??1)&&(t=this.P(),Object.assign(this.o.style,{position:"fixed",width:t.w,left:t.left,top:t.top,margin:"0"}))})):(this.C("in"),e?.(),setTimeout((()=>{i((()=>{setTimeout((()=>i((()=>this.C(t,!0)))),0)}))}),n.trans?.swap||0)),setTimeout((()=>{i((()=>{"out"==t?this.O():this.C(l,!0),n.trans?.hooks?.[`${t}-end`]?.(this.o),this.o.style.transitionDuration="","in"==t&&s?.(this)}))}),r+("in"==t&&n.trans?.swap||0))}O(){this.L?.forEach(((t,e)=>{this.o?.removeEventListener(e,t)})),this.A?.forEach((t=>{this.A?.delete(t)})),this.I("._mfld",!0)?.forEach((t=>{m.get(t)?.O()})),this.o.remove(),this.A=this.L=this.o=null,this.o&&m.delete(this.o)}}let w=(t,e,s,i,n,o,r)=>{let l=e=>_(e,n,s,i,t,!0,o,r);"$mount"===e?l():t.N(e,l)},_=async(t,e,s,n,o,r,l,a)=>{t?.preventDefault(),t?.stopPropagation(),e||(e=t?.target?.method||"get");let c=s.fetch?.externals?.find((t=>"$origin"===t.domain&&(n.startsWith(location.origin)||!n.match(/^(https?):\/\//))||n.startsWith(t.domain)));c||(c=n.startsWith(location.origin)?{domain:"$origin",scripts:"selected",styles:"selected"}:void 0);let f=l?l({$el:o,$st:$,$fn:p}):void 0,d="$form"===f?new FormData(o.o):f,m=await fetch(n,{...s.fetch?.request||{},headers:{...s.fetch?.request?.headers,MFLD:"true"},method:e,body:"$form"===f||"string"==typeof d?d:JSON.stringify(d)}).catch((t=>{s.fetch?.err?.(t)})),w=m?.status;if(w&&!1===s.fetch?.onCode?.(w,m))return;let _=await(m?.[s.fetch?.resType||"text"]());for(let t of["append","prepend","inner","outer"]){let e=o.u(t);if(!e)continue;let[n,l]=e.split("->").map((t=>t.trim())),h=(new DOMParser).parseFromString(_,"text/html"),u=new y({parent:h,query:n||"body",ops:s});if(h){let e=[];if(c?.styles&&"none"!==c.styles||h.querySelectorAll("style").forEach((t=>t.parentNode?.removeChild(t))),"all"===c?.styles&&h.querySelectorAll("style").forEach((t=>u?.i(t,"append",!1))),("all"===c?.scripts?h:u.o)?.querySelectorAll("script").forEach((t=>{["all","selected"].includes(c?.scripts||"")&&e.push(t),t.parentNode?.removeChild(t)})),u)if(r)i({in:u,out:l?new y({query:l,ops:s}):o,relation:t,ops:s,done:t=>{a?.(t);for(let s of e){let e=document.createElement("script");e.textContent=s.textContent,t?.i(e,"append",!1)}}});else{document.body.appendChild(u.o);for(let t of e){let e=document.createElement("script");for(let s of t.attributes)e.setAttribute(s.name,s.value);e.textContent=t.textContent,u.o.before(e)}}}}let g=o.u("resolve"),b=h(g||"")?.func;b?.({$el:o,$st:$,$fn:p,$body:_}),r&&u(o,t,n)},g=(t,e,s)=>{console.log("BINDING",t),((t,e,s)=>{let i=l();s?.u("cstore",i),console.log("REGISTERING",t,e,s?.o),d(i,{upstream:t,updater:()=>e?.({$el:s,$st:S,$fn:F})})})(s,(()=>t.G(e)?.({$el:t.o,$st:$,$fn:p})),t)},b=(t,e,s)=>{let i=e=>{s?.({$el:t.o,$st:$,$fn:p}),e&&u(t,e)};"$mount"===e?i():t.N(e,i)},M={},T=["bind","sync","templ","if","elseif","else","each","get","head","post","put","delete","patch","promote"].map((t=>`${o}${t}`));window.addEventListener("popstate",(()=>{location.reload()}));let v=t=>{if(t?.nodeType==Node.TEXT_NODE)return;let e=(t||document.body).querySelectorAll(`[data-${T.join("],[data-")}],a,form`);for(let s of[t,...e].map((t=>new y({element:t,ops:M})))){let t=a(structuredClone(M),s);if(s.u?.("promote")){let[e,i,n,o]="A"==s.o.tagName?["get",s.o.href,void 0,"click"]:[s.o.method.toLowerCase(),s.o.action,()=>"$form","submit"];if(i){w(s,o,t,i,e,n,(t=>v(t)));continue}}for(let e in s?.p())if(T.includes(e)){console.log("GOT MODE",e,s,t);for(let i of s.u(e)?.split(";;")||[]){let n=!!/get|head|post|put|delet e|patch/.test(e),l=i?.split(/\s*->\s*/g),a=n&&l.pop()||"",u=n||/sync/.test(e)?l.shift()?.match(/[^\(\)]{1,}/g)?.pop()?.split(r)?.map((t=>t.trim())):[]||[],c=l?.[0]||"",f=Array.from(new Set([...c?.matchAll(/\$st\.(\w{1,})/g)].map((t=>t[1])))),{func:d,as:p}=h(c);if(console.log("SETTINGS",d,"AS",p,"DL",f,"TRIGGERS",u),/each|templ|if|else/.test(e));else{u?.length||(u=[""]);for(let i of u)/bind/.test(e)?g(s,d,f):/sync/.test(e)?b(s,i,d):w(s,i,t,a,e.replace(o,""),d)}}}}},D={store:(t,e)=>(e?.hasOwnProperty("value")||e?.hasOwnProperty("updater")||(e={value:e}),d(t,e)),ustore:(t,e)=>d(t,e),funcs:t=>{for(let e in t)MFLD.$fn[e]=t[e]},config:(t,e)=>{return s=t,void((i=e)?M.profiles={...M.profiles,[i]:s}:M={...M,...s});var s,i},onTick:t=>{var e;(e=t)&&s.push(e)},register:t=>v("string"==typeof t?document.querySelector(t):t),makeComponent:(t,e)=>{MFLD.comp[t]=class extends HTMLElement{template=null;connected;adopted;disconnected;attributeChanged;constructor(){super(),e?.constructor?.bind(this)?.(),this.connected=e?.connected?.bind(this),this.adopted=e?.adopted?.bind(this),this.disconnected=e?.disconnected?.bind(this),this.attributeChanged=e?.attributeChanged?.bind(this),this.template=new y({ops:e?.options||{},element:e?.templ||document.getElementById(e?.selector||t)})}connectedCallback(){let t=this.attachShadow({mode:e?.shadow||"closed"}),s=(this.template?.o).content.cloneNode(!0);if(s){t.append(s);for(let e of Array.from(t.children))if("SLOT"==e.nodeName)for(let t of e.assignedNodes())v(t);else"TEMPLATE"!=e.nodeName&&v(e)}}attributeChangedCallback(t,e,s){this.attributeChanged?.(t,e,s)}disconnectedCallback(){this.disconnected?.()}adoptedCallback(){this.adopted?.()}static get observedAttributes(){return e?.observedAttributes||[]}},MFLD.comp[t]&&customElements.define(t,MFLD.comp[t])},component:async t=>{}},S=MFLD.$st,F=MFLD.$fn;export{F as $fn,S as $st,D as Mfld};
