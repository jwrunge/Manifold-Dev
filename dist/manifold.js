window.MFLD||(window.MFLD={st:new Map,els:new Map,$st:o(),$fn:{},comp:{}});let t="mf-",e=/, {0,}/g,{$st:s,$fn:n}=window.MFLD,i=(e,s)=>{let n=e.profiles?.[s.getAttribute("override")||""],i={...e,...n};for(let e in s?.attributes||[])for(let n of["fetch","trans"])if(e.startsWith(`${t}${n}_`))try{let t=e.split("_")[2],o=s.getAttribute(n);o?.match(/\{|\[/)?o=JSON.parse(o):parseInt(o||"")&&(o=parseInt(o)),Array.isArray(o)&&(o=o.map((t=>parseInt(t)||t))),i?.[n]?.[t]&&(i[n][t]=o)}catch(t){console.error(t)}return i};function o(t){return new Proxy(_,{get:(e,s)=>(t&&(s=t.find((t=>t.key==s))?.store||s),"string"==typeof s?e(s)?.value:void 0),set:(e,s,n)=>{if("string"==typeof s){let i=s.split(/[\.\[\]\?]{1,}/g).map((t=>parseFloat(t.trim())||t.trim()));t&&(i[0]=t.find((t=>t.key==i[0]))?.store||i[0]);let o=e(i[0]),l=o.value;for(let t of i.slice(1)||[])l=l[t];l=n,o.update(l)}return!0}})}window.MFLD.stProx||(window.MFLD.stProx=o);let l=(t,s=[],n=[],i=[])=>{try{let[o,l]=t?.split(/\s{1,}as\s{1,}/)||[t,"value"],r=`let $var = MFLD?.stProx?.(${JSON.stringify(s)});`,f=n?.length?`for(let dep of ${JSON.stringify(n)}){if($st[dep]) return false;}`:"",c=o?.match(/^\s{0,}(function)?\(.{0,}\)(=>)?\s{0,}/)?`(${o})()`:o,a=`let {$el,$st,$fn,$body${i?","+i.join(","):""}}=ops;${r}${f}return ${c}`,u=l?.split?.(e)?.map?.((t=>t.trim()))||["value"]||[],h=Array.from(new Set([...[...o?.matchAll(/\$st\.(\w{1,})/g)].map((t=>t[1])),...[...o?.matchAll(/\$var\.(\w{1,})/g)].map((t=>s.find((e=>e.key==t[1]))?.store||""))]));return c?{func:new Function("ops",a),as:u,dependencyList:h}:{}}catch(t){return console.error(t),{}}};function r(t,e,s){e?.preventDefault();let n=t?.getAttribute("pushstate"),i=s;switch(n){case"":break;case void 0:return;default:i=`#${n}`}history.pushState(null,"",i)}function f(t,e,i,o){let l={$el:t,$st:s,$fn:n},r=_(`${Date.now()}_${Math.floor(1e5*Math.random())}`,{updater:()=>e?.(l),dependencyList:i,internal:!0});return o&&r.sub(o),r}let c=[],a=new Set,u=0,h=[],d=t=>{t&&h.push(t)},p=t=>{"function"==typeof t?c.push(t):a.add(t),u||(u=requestAnimationFrame((()=>m())))};function m(t=0){if(t>100)return void console.error("MFLD: Recursion limit reached - check for circular references.");u=0,t++;for(let t of c)t();let e=new Set;for(let t of a){let i=!1;for(let e of t.t)if(a.has(e)){i=!0;break}if(i)e.add(t);else{let e=t.i?.({$st:s,$fn:n,$el:t.o});t.update(void 0===e?t.value:e)}}c=[],a.clear(),e.size?(a=e,m(t)):(a.size&&m(t),h.forEach((t=>t())),h=[])}function $(t,e,s){p((()=>{s?.()}))}function w(t){if(!t||!isNaN(t)||!0===t)return t;if(t instanceof Map||t instanceof Set)return w(Array.from(t.entries()||t));let e=0;for(let s of(new TextEncoder).encode(t?.toString()||""))e=(e<<5)-e+s;return e}class y{i;l=new Set;u;t=new Set;h=new Set;o;name;value;constructor(t,e){this.name=t,MFLD.st.set(t,this),this.o=e?.scope,this.value="function"!=typeof e?.value?e?.value:void 0,this.p(e)}p(t){return t?.dependencyList?.map((t=>{let e=_(t);return this.t.add(e),e.h.add(this),e})),this.value=t?.value,this.i=t?.updater,p(this),this}sub(t,e=!0){this.l.add(t),e&&t(this.value)}update(t){setTimeout((()=>{let e="function"==typeof t?t(this.value):t,s=w(e);if(s!==this.u){this.value=e,this.u=s;for(let t of this.h)p(t);for(let t of Array.from(this.l))t(this.value)}}),0)}}function _(t,e){let s=MFLD.st.get(t);return e?s?s.p(e):new y(t,e):s||new y(t,e)}let g=(t,e,s,n,i,o,l)=>{let r=e=>b(e,i,s,n,null,t,!0,o,l);"$mount"===e?r():t.addListener(e,r)},v=(t,e,s,n)=>{let i=t.fetch?.externals?.find((t=>"$origin"===t.domain&&(e.startsWith(location.origin)||!e.match(/^(https?):\/\//))||e.startsWith(t.domain)));i||(i=e.startsWith(location.origin)?{domain:"$origin",script:"selected",style:"selected"}:void 0);let[o,l]=["style","script"].map((t=>Array.from(("all"==i?.[t]?s:n)?.querySelectorAll(t))));if("all"===i?.style)o.forEach((t=>n?.append(t)));else o.forEach((t=>t.parentNode?.removeChild(t)));for(let t of l)t.parentNode?.removeChild(t);return l},b=async(t,e,i,o,f,c,a,u,h)=>{t?.preventDefault();let d=u?u({$el:c,$st:s,$fn:n}):void 0,p="$form"===d?new FormData(c?.m):d,m=await fetch(o,{...i.fetch?.request||{},headers:{...i.fetch?.request?.headers,MFLD:"true"},method:e||t?.target?.method||"get",body:"$form"===d||"string"==typeof p?p:JSON.stringify(p)}).catch((t=>{i.fetch?.err?.(t)})),w=m?.status,y=await(m?.[i.fetch?.resType||"text"]());if(w&&!1===i.fetch?.onCode?.(w,m))return;for(let t of f?[""]:["append","prepend","insert","replace"]){let e=f||c?.m?.getAttribute(t);if(null==e)continue;let[s,n]=e.split("->").map((t=>t.trim())),l=(new DOMParser).parseFromString(y,"text/html"),r=l.querySelector(s),u=v(i,o,l,r);if(r)if(a)$(0,0,(()=>{h?.(c);for(let t of u){let e=document.createElement("script");e.textContent=t.textContent,c?.m?.append(e)}})),c?.m&&$(n?c?.m?.querySelector(n):c.m);else{document.body.append(r);for(let t of u){let e=document.createElement("script");for(let s of t.attributes)e.setAttribute(s.name,s.value);e.textContent=t.textContent,r.before(e)}}}let _=c?.m?.getAttribute("resolve"),g=l(_||"")?.func;g?.({$el:c,$st:s,$fn:n,$body:y}),a&&r(c?.m,t,o)},M=(e,s)=>{MFLD.comp[e]||(MFLD.comp[e]=class extends HTMLElement{template=null;context=new Set;deps=new Set;shadow=null;eachController=null;eachAliases=[];showController=null;controller=null;onConnect;onAdopted;onDisconnect;onAttributeChanged;constructor(){super(),s?.onconstruct?.bind(this)?.(),this.onConnect=s?.onConnect?.bind(this),this.onAdopted=s?.onAdopted?.bind(this),this.onDisconnect=s?.onDisconnect?.bind(this),this.onAttributeChanged=s?.onAttributeChanged?.bind(this),this.template=document.getElementById(s?.selector||e)||this.querySelector("template")||(()=>{let t=document.createElement("template");return S(t,this),t})(),this.classList.contains("_mf-cmp")||this.classList.add("_mf-cmp")}connectedCallback(){0!=s?.shadow&&(this.shadow=this.attachShadow({mode:s?.shadow||"closed"}));let e=this.parentNode?.closest?.("._mf-cmp");e&&(this.context=e?.context||new Map);for(let e of this.attributes){if(["id","class"].includes(e.name)||e.name.startsWith(t))continue;let s=["if","else","elseif"].includes(e.name),n=null,i=[];if(["else","elseif"].includes(e.name)){let t=this;for(;(t=t?.previousElementSibling)&&t.classList.contains("_mf-cmp")&&(t.showController&&i.push(t.showController?.name),!t.getAttribute("if")););}e.value&&"each"!=e.name||(e.value="true");let{func:o,as:r,dependencyList:c}=l(e.value,Array.from(this.context),i);if(s)this.showController=f(this,o,i);else if("each"==e.name)this.eachAliases=r||["val","key"],this.eachController=f(this,o,c);else{for(let[t,e]of[[c,""],[this.context,"store"]])for(let s of t||[])this.deps.add(e?s[e]:s);n=f(this,o,Array.from(this.deps))}this.context.add({key:e.name,store:n?.name||""})}this.$(this.eachController?.value)}_(){let t=document.createElement("span");console.log("CLEARING",this.innerHTML,"SHADOW",this.shadow?.innerHTML),$(0,0,(()=>t.remove()))}$(t){if(this._(),!1===this.showController?.value)return;console.log("RENDERING");let e=this.template.content.cloneNode(!0);this.shadow?.append(e)}attributeChangedCallback=this.onAttributeChanged;adoptedCallback=this.onAdopted;disconnectedCallback(){this.onDisconnect?.()}static get observedAttributes(){return s?.observedAttributes||[]}},MFLD.comp[e]&&customElements.define(e,MFLD.comp[e]))},S=(t,e)=>{t.innerHTML=e.innerHTML,e.innerHTML=""};M("mf-templ",{shadow:!1});class L{m=null;v=new Map;M=new Set;S=!1;L=new Set;constructor(t,e){this.m=t;for(let t of e||[])this.L.add(t);window.MFLD.els.set(t,this)}addListener(t,e){this.v.set(t,e),this.m?.addEventListener(t,e)}addInternalStore(t){this.M.add(t)}cleanUp(){this.v.forEach(((t,e)=>{this.m?.removeEventListener(e,t)})),this.m?.remove(),this.m=null}}let A={},D=["bind","sync","get","head","post","put","delete","patch","promote"],F=(t,e)=>{e?A.profiles={...A.profiles,[e]:t}:A={...A,...t}};window.addEventListener("popstate",(()=>{location.reload()}));let C=(o,c)=>{if(!o||o?.nodeType==Node.TEXT_NODE)return;let a=o.querySelectorAll(`[${t}${D.join(`],[${t}`)}]`);for(let u of c?.noparent?[...a]:[o,...a]){if(u!==o){let t=u.parentNode.closest("._mf-cmp");if(t&&t!==o)continue}let a=window.MFLD.els.get(u)||new L(u,c?.fnCtx);if(a.S)continue;a.S=!0;let h=i(structuredClone(A),a.m);for(let i of a.m?.attributes||[]){if(!i.name.startsWith(t)||null===i.value)continue;let o=i.name.replace(t,"");if("promote"!=o)for(let t of a.m?.getAttribute(i.name)?.split(";;")||[""]){let c=!/bind|sync/.test(i.name),u=t?.split(/\s*->\s*/g),d=c&&u.pop()||"",p=c||"sync"==o?u.shift()?.match(/[^\(\)]{1,}/g)?.pop()?.split(e)?.map((t=>t.trim()))||[]:null,m=u?.[0]||"",{func:$,dependencyList:w}=l(m,Array.from(a.L)||[]);if(p)for(let t of p)if("sync"==o){let e=t=>{$?.({$el:a.m,$st:s,$fn:n}),r(a.m,t)};"$mount"===t?e():a.m?.addEventListener(t,e)}else g(a,t,h,d,o,$);else a.addInternalStore(f(a.m,$,w,void 0))}else{let[t,e,s,n]="A"==a.m?.tagName?["get",a.m.href,void 0,"click"]:[a.m.method?.toLowerCase(),a.m.action,()=>"$form","submit"];e&&g(a,n,h,e,t,s,(t=>C(t,{fnCtx:c?.fnCtx})))}}}};setTimeout((()=>C(document.body)),0);let k={make:(t,e)=>(e?.hasOwnProperty("value")||e?.hasOwnProperty("updater")||(e={value:e}),_(t,e)),untyped:(t,e)=>_(t,e),funcs:t=>{for(let e in t)MFLD.$fn[e]=t[e]}},x={make:M,get:async(t,e,s)=>{document.querySelectorAll(t).forEach((t=>t.classList.add("_mf-cmp"))),b(void 0,"get",{},e,"template -> body",null,!1).then((()=>{M(t,s)}))}};export{n as $fn,s as $st,x as component,F as config,d as onTick,k as store};
