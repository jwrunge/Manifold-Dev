window.MFLD||(window.MFLD={st:new Map,els:new Map,$st:r(),$fn:{},comp:{}});let t="mf-",e=/, {0,}/g,{$st:n,$fn:o}=window.MFLD,s=()=>`${Date.now()}_${Math.floor(1e5*Math.random())}`,i=(e,n)=>{let o=e.profiles?.[n.getAttribute("override")||""],s={...e,...o};for(let e in n?.attributes||[])for(let o of["fetch","trans"])if(e.startsWith(`${t}${o}_`))try{let t=e.split("_")[2],i=n.getAttribute(o);i?.match(/\{|\[/)?i=JSON.parse(i):parseInt(i||"")&&(i=parseInt(i)),Array.isArray(i)&&(i=i.map((t=>parseInt(t)||t))),s?.[o]?.[t]&&(s[o][t]=i)}catch(t){console.error(t)}return s};function r(t){return new Proxy(M,{get:(e,n)=>(t&&(n=t.find((t=>t.key==n))?.store||n),"string"==typeof n?e(n)?.value:void 0),set:(e,n,o)=>{if("string"==typeof n){let s=n.split(/[\.\[\]\?]{1,}/g).map((t=>parseFloat(t.trim())||t.trim()));t&&(s[0]=t.find((t=>t.key==s[0]))?.store||s[0]);let i=e(s[0]),r=i.value;for(let t of s.slice(1)||[])r=r[t];r=o,i.update(r)}return!0}})}window.MFLD.stProx||(window.MFLD.stProx=r);let l=(t,n=[],o=[])=>{try{let[s,i]=t?.split(/\s{1,}as\s{1,}/)||[t,"value"],r=o?`let $var = MFLD?.stProx?.(${JSON.stringify(o)});`:"",l=s?.match(/^\s{0,}(function)?\(.{0,}\)(=>)?\s{0,}/)?`(${s})()`:s,f=`let {$el,$st,$fn,$body${n?.length?","+n.join(","):""}}=ops;${r};return ${l}`,a=i?.split?.(e)?.map?.((t=>t.trim()))||["value"]||[],c=Array.from(new Set([...[...s?.matchAll(/\$st\.(\w{1,})/g)].map((t=>t[1])),...[...s?.matchAll(/\$var\.(\w{1,})/g)].map((t=>o.find((e=>e.key==t[1]))?.store||""))]));return l?{func:new Function("ops",f),as:a,dependencyList:c}:{}}catch(t){return console.error(t),{}}};function f(t,e,n){e?.preventDefault();let o=t?.getAttribute("pushstate"),s=n;switch(o){case"":break;case void 0:return;default:s=`#${o}`}history.pushState(null,"",s)}function a(t,e,i,r){let l={$el:t,$st:n,$fn:o},f=M(s(),{updater:()=>e?.(l),dependencyList:i,internal:!0});return r&&f.sub(r),f}let c=[],u=new Set,h=0,d=[],p=t=>{t&&d.push(t)},$=t=>{"function"==typeof t?c.push(t):u.add(t),h||(h=requestAnimationFrame((()=>m())))};function m(t=0){if(t>100)return void console.error("MFLD: Recursion limit reached - check for circular references.");h=0,t++;for(let t of c)t();let e=new Set;for(let t of u){let s=!1;for(let e of t.t)if(u.has(e)){s=!0;break}if(s)e.add(t);else{let e=t.o?.({$st:n,$fn:o,$el:t.i});t.update(void 0===e?t.value:e)}}c=[],u.clear(),e.size?(u=e,m(t)):(u.size&&m(t),d.forEach((t=>t())),d=[])}function w(t,e,n){$((()=>{n?.()}))}function y(t){if(!t||!isNaN(t)||!0===t)return t;if(t instanceof Map||t instanceof Set)return y(Array.from(t.entries()||t));let e=0;for(let n of(new TextEncoder).encode(t?.toString()||""))e=(e<<5)-e+n;return e}class g{o;l=new Set;u;t=new Set;h=new Set;i;name;value;constructor(t,e){this.name=t,MFLD.st.set(t,this),this.i=e?.scope,this.value="function"!=typeof e?.value?e?.value:void 0,this.p(e)}p(t){return t?.dependencyList?.map((t=>{let e=M(t);return this.t.add(e),e.h.add(this),e})),this.value=t?.value,this.o=t?.updater,$(this),this}sub(t,e=!0){this.l.add(t),e&&t(this.value)}update(t){setTimeout((()=>{let e="function"==typeof t?t(this.value):t,n=y(e);if(n!==this.u){this.value=e,this.u=n;for(let t of this.h)$(t);for(let t of Array.from(this.l))t(this.value)}}),0)}}function M(t,e){let n=MFLD.st.get(t);return e?n?n.p(e):new g(t,e):n||new g(t,e)}let b=(t,e,n,o,s,i,r)=>{let l=e=>S(e,s,n,o,null,t,!0,i,r);"$mount"===e?l():t.addListener(e,l)},v=(t,e,n,o)=>{let s=t.fetch?.externals?.find((t=>"$origin"===t.domain&&(e.startsWith(location.origin)||!e.match(/^(https?):\/\//))||e.startsWith(t.domain)));s||(s=e.startsWith(location.origin)?{domain:"$origin",script:"selected",style:"selected"}:void 0);let[i,r]=["style","script"].map((t=>Array.from(("all"==s?.[t]?n:o)?.querySelectorAll(t))));if("all"===s?.style)i.forEach((t=>o?.append(t)));else i.forEach((t=>t.parentNode?.removeChild(t)));for(let t of r)t.parentNode?.removeChild(t);return r},S=async(t,e,s,i,r,a,c,u,h)=>{t?.preventDefault();let d=u?u({$el:a,$st:n,$fn:o}):void 0,p="$form"===d?new FormData(a?.$):d,$=await fetch(i,{...s.fetch?.request||{},headers:{...s.fetch?.request?.headers,MFLD:"true"},method:e||t?.target?.method||"get",body:"$form"===d||"string"==typeof p?p:JSON.stringify(p)}).catch((t=>{s.fetch?.err?.(t)})),m=$?.status,y=await($?.[s.fetch?.resType||"text"]());if(m&&!1===s.fetch?.onCode?.(m,$))return;for(let t of r?[""]:["append","prepend","insert","replace"]){let e=r||a?.$?.getAttribute(t);if(null==e)continue;let[n,o]=e.split("->").map((t=>t.trim())),l=(new DOMParser).parseFromString(y,"text/html"),f=l.querySelector(n),u=v(s,i,l,f);if(f)if(c)w(0,0,(()=>{h?.(a);for(let t of u){let e=document.createElement("script");e.textContent=t.textContent,a?.$?.append(e)}})),a?.$&&w(o?a?.$?.querySelector(o):a.$);else{document.body.append(f);for(let t of u){let e=document.createElement("script");for(let n of t.attributes)e.setAttribute(n.name,n.value);e.textContent=t.textContent,f.before(e)}}}let g=a?.$?.getAttribute("resolve"),M=l(g||"")?.func;M?.({$el:a,$st:n,$fn:o,$body:y}),c&&f(a?.$,t,i)};class L{$=null;m=new Map;M=new Set;v=!1;S=new Set;constructor(t,e){this.$=t;for(let t of e||[])this.S.add(t);window.MFLD.els.set(t,this)}addListener(t,e){this.m.set(t,e),this.$?.addEventListener(t,e)}addInternalStore(t){this.M.add(t)}cleanUp(){this.m.forEach(((t,e)=>{this.$?.removeEventListener(e,t)})),this.$?.remove(),this.$=null}}let _={},A=["bind","sync","get","head","post","put","delete","patch","promote"],D=(t,e)=>{e?_.profiles={..._.profiles,[e]:t}:_={..._,...t}};window.addEventListener("popstate",(()=>{location.reload()}));let F=(s,r)=>{if(!s||s?.nodeType==Node.TEXT_NODE)return;let c=s.querySelectorAll(`[${t}${A.join(`],[${t}`)}]`);for(let u of r?.noparent?[...c]:[s,...c]){if(u!==s){let t=u.closest("._mf-component");if(t&&t!==s)continue}let c=window.MFLD.els.get(u)||new L(u,r?.fnCtx);if(c.v)continue;c.v=!0;let h=i(structuredClone(_),c.$);for(let s of c.$?.attributes||[]){if(!s.name.startsWith(t)||null===s.value)continue;let i=s.name.replace(t,"");if("promote"!=i)for(let t of c.$?.getAttribute(s.name)?.split(";;")||[""]){let r=!/bind|sync/.test(s.name),u=t?.split(/\s*->\s*/g),d=r&&u.pop()||"",p=r||"sync"==i?u.shift()?.match(/[^\(\)]{1,}/g)?.pop()?.split(e)?.map((t=>t.trim()))||[]:null,$=u?.[0]||"",{func:m,dependencyList:w}=l($,[],Array.from(c.S)||[]);if(p)for(let t of p)if("sync"==i){let e=t=>{m?.({$el:c.$,$st:n,$fn:o}),f(c.$,t)};"$mount"===t?e():c.$?.addEventListener(t,e)}else b(c,t,h,d,i,m);else c.addInternalStore(a(c.$,m,w,void 0))}else{let[t,e,n,o]="A"==c.$?.tagName?["get",c.$.href,void 0,"click"]:[c.$.method?.toLowerCase(),c.$.action,()=>"$form","submit"];e&&b(c,o,h,e,t,n,(t=>F(t,{fnCtx:r?.fnCtx})))}}}};setTimeout((()=>F(document.body)),0);let k=(t,e)=>{t.innerHTML=e.innerHTML,e.innerHTML=""};function x(t,e,s,i,r=["$val","$key"]){let f,c=e.match(/if|else/),u=new Set;if(e.match(/else/)){let r=t,l=0;for(;r=r?.previousElementSibling;){for(let t of r.conditionalDeps)i.add(t);if(l++>100){console.error("MFLD: No if start found");break}if(r.getAttribute("if"))break}f=()=>{for(let t of u)if(n[t])return!1;return"else"==e||!0===s?.({$st:n,$fn:o})}}else f=s;a(t,f,Array.from(i),(s=>{if(void 0===s)return;let i=document.createElement("span");k(i,t),t.before(i),w(0,0,(()=>i.remove())),c&&!s||((t,e)=>{if(t instanceof Map)for(let[n,o]of t.entries())e(o,n);else try{let n=Array.isArray(t)?t:Array.from(t);if(n.length)n.forEach(e);else for(let n in t)e(t[n],n)}catch(e){console.error(`MFLD: ${t} is not iterable`)}})("each"==e?s:[s],((e,s)=>{let i=t.template?.cloneNode(!0);c||(i.innerHTML=i.innerHTML?.replace(/{(\$[^}]*)}/g,((t,i)=>l(i,r.map((t=>`$${t}`))).func?.({$st:n,$fn:o,[`$${r[0]}`]:e,[`$${r[1]}`]:s})??""))||String(e)),t.append(i.content),w(0,0,(()=>F(t,{noparent:!0})))}))}))}let C=(e,n)=>{MFLD.comp[e]||(MFLD.comp[e]=class extends HTMLElement{template=null;context=new Set;deps=new Set;conditionalDeps=new Set;onConnect;onAdopted;onDisconnect;onAttributeChanged;constructor(){super(),n?.onconstruct?.bind(this)?.(),this.onConnect=n?.onConnect?.bind(this),this.onAdopted=n?.onAdopted?.bind(this),this.onDisconnect=n?.onDisconnect?.bind(this),this.onAttributeChanged=n?.onAttributeChanged?.bind(this),this.template=document.getElementById(n?.selector||e)||this.querySelector("template")||(()=>{let t=document.createElement("template");return k(t,this),t})(),this.classList.contains("_mf-component")||this.classList.add("_mf-component")}connectedCallback(){let e=0!=n?.shadow?this.attachShadow({mode:n?.shadow||"closed"}):null,o=this.template.content.cloneNode(!0),s=this.parentNode?.closest?.("._mf-component");s&&(this.context=s?.context||new Map);for(let e of this.attributes){if(["id","class"].includes(e.name)||e.name.startsWith(t))continue;let{func:n,as:o,dependencyList:s}=l(e.value,[],Array.from(this.context));if(n){for(let t of s||[])this.deps.add(t),["if","else","elseif","each"].includes(e.name)&&this.conditionalDeps.add(t);for(let t of this.context)this.deps.add(t.store),["if","else","elseif","each"].includes(e.name)&&this.conditionalDeps.add(t.store);let t=a(this,n,Array.from(this.deps));this.context.add({key:e.name,store:t.name}),e.name.match(/if|else|each/)&&x(this,e.name,n,this.deps,o)}}if(o){e?.append(o);for(let t of Array.from(e?.children||this.children))if("SLOT"==t.nodeName)for(let e of t.assignedNodes())F(e,{fnCtx:this.context});else"TEMPLATE"!=t.nodeName&&F(t,{fnCtx:this.context})}}attributeChangedCallback=this.onAttributeChanged;adoptedCallback=this.onAdopted;disconnectedCallback=this.onDisconnect;static get observedAttributes(){return n?.observedAttributes||[]}},MFLD.comp[e]&&customElements.define(e,MFLD.comp[e]))};C("mf-templ",{shadow:!1});let N={make:(t,e)=>(e?.hasOwnProperty("value")||e?.hasOwnProperty("updater")||(e={value:e}),M(t,e)),untyped:(t,e)=>M(t,e),funcs:t=>{for(let e in t)MFLD.$fn[e]=t[e]}},T={make:C,register:async(t,e,n)=>{document.querySelectorAll(t).forEach((t=>t.classList.add("_mf-component"))),S(void 0,"get",{},e,"template -> body",null,!1).then((()=>{C(t,n)}))}};export{o as $fn,n as $st,T as component,D as config,p as onTick,N as store};
