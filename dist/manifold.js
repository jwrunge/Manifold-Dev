window.MFLD||(window.MFLD={st:new Map,els:new Map,$st:new Proxy(d,{get:(e,t)=>"string"==typeof t?e(t)?.value:void 0,set:(e,t,n)=>{if("string"==typeof t){let s=t.split(/[\.\[\]\?]{1,}/g).map((e=>parseFloat(e.trim())||e.trim())),o=e(s[0]),l=o.value;for(let e of s.slice(1)||[])l=l[e];l=n,o.update(l)}return!0}}),$fn:{},comp:{}});let{$fn:e,$st:t}=MFLD,n=[],s=new Set,o=0,l=[],i=e=>{e&&l.push(e)},r=e=>{"function"==typeof e?n.push(e):s.add(e),o||(o=requestAnimationFrame((()=>f())))};function f(i=0){if(i||console.log("%cRunning batched updates","background: yellow; color: red;",performance.now()),i>100)return void console.error("MFLD: Recursion limit reached - check for circular references.");o=0,i++;for(let e of n)e();let r=new Set;for(let n of s){let o=!1;for(let e of n.t)if(s.has(e)){o=!0;break}if(o)r.add(n);else{let s=n.o?.({$st:t,$fn:e,$el:n.l});n.update(void 0===s?n.value:s)}}n=[],s.clear(),r.size?(s=r,f(i)):(s.size&&f(i),l.forEach((e=>e())),l=[])}function c(e,t,n){r((()=>{n?.()}))}function a(e){if(!e||!isNaN(e)||!0===e)return e;if(e instanceof Map||e instanceof Set)return a(Array.from(e.entries()||e));let t=0;for(let n of(new TextEncoder).encode(e?.toString()||""))t=(t<<5)-t+n;return t}class u{o;i=new Set;u;t=new Set;h=new Set;l;name;value;constructor(e,t){this.name=e,MFLD.st.set(e,this),this.l=t?.scope,this.value="function"!=typeof t?.value?t?.value:void 0,this.p(t)}p(e){return e?.dependencyList?.map((e=>{let t=d(e);return this.t.add(t),t.h.add(this),t})),this.value=e?.value,this.o=e?.updater,r(this),this}sub(e,t=!0){this.i.add(e),t&&e(this.value)}update(e){setTimeout((()=>{let t="function"==typeof e?e(this.value):e,n=a(t);if(n!==this.u){this.value=t,this.u=n;for(let e of this.h)r(e);for(let e of Array.from(this.i))e(this.value)}}),0)}}function d(e,t){let n=MFLD.st.get(e);return t?n?n.p(t):new u(e,t):n||new u(e,t)}let h="mf-",p=/, {0,}/g,$=()=>`${Date.now()}.${Math.floor(1e5*Math.random())}`,m=(e,t)=>{let n=e.profiles?.[t.getAttribute("override")||""],s={...e,...n};for(let e in t?.attributes||[])for(let n of["fetch","trans"])if(e.startsWith(`${h}${n}_`))try{let o=e.split("_")[2],l=t.getAttribute(n);l?.match(/\{|\[/)?l=JSON.parse(l):parseInt(l||"")&&(l=parseInt(l)),Array.isArray(l)&&(l=l.map((e=>parseInt(e)||e))),s?.[n]?.[o]&&(s[n][o]=l)}catch(e){console.error(e)}return s},w=(e,t=[])=>{try{let[n,s]=e?.split(/\s{1,}as\s{1,}/)||[e,"value"],o=n?.match(/^\s{0,}(function)?\(.{0,}\)(=>)?\s{0,}/)?`(${n})()`:n,l=`let {$el,$st,$fn,$body${t?.length?","+t.join(","):""}}=ops;console.log(ops);return ${o}`,i=s?.split?.(p)?.map?.((e=>e.trim()))||["value"]||[],r=Array.from(new Set([...n?.matchAll(/\$st\.(\w{1,})/g)].map((e=>e[1]))));return console.log("FN",l),o?{func:new Function("ops",l),as:i,dependencyList:r}:{}}catch(e){return console.error(e),{}}};function y(e,t,n){t?.preventDefault();let s=e?.getAttribute("pushstate"),o=n;switch(s){case"":break;case void 0:return;default:o=`#${s}`}history.pushState(null,"",o)}function g(n,s,o,l,i){let r=d($(),{updater:()=>s?.({$el:n,$st:t,$fn:e,...i?.map((e=>({[`${e.key}`]:e.func?.()})))}),dependencyList:o,internal:!0});return l&&r.sub(l),r}let b=(e,t,n,s,o,l,i)=>{let r=t=>L(t,o,n,s,null,e,!0,l,i);"$mount"===t?r():e.addListener(t,r)},M=(e,t,n,s)=>{let o=e.fetch?.externals?.find((e=>"$origin"===e.domain&&(t.startsWith(location.origin)||!t.match(/^(https?):\/\//))||t.startsWith(e.domain)));o||(o=t.startsWith(location.origin)?{domain:"$origin",script:"selected",style:"selected"}:void 0);let[l,i]=["style","script"].map((e=>Array.from(("all"==o?.[e]?n:s)?.querySelectorAll(e))));if("all"===o?.style)l.forEach((e=>s?.append(e)));else l.forEach((e=>e.parentNode?.removeChild(e)));for(let e of i)e.parentNode?.removeChild(e);return i},L=async(n,s,o,l,i,r,f,a,u)=>{n?.preventDefault();let d=a?a({$el:r,$st:t,$fn:e}):void 0,h="$form"===d?new FormData(r?.$):d,p=await fetch(l,{...o.fetch?.request||{},headers:{...o.fetch?.request?.headers,MFLD:"true"},method:s||n?.target?.method||"get",body:"$form"===d||"string"==typeof h?h:JSON.stringify(h)}).catch((e=>{o.fetch?.err?.(e)})),$=p?.status,m=await(p?.[o.fetch?.resType||"text"]());if($&&!1===o.fetch?.onCode?.($,p))return;for(let e of i?[""]:["append","prepend","insert","replace"]){let t=i||r?.$?.getAttribute(e);if(null==t)continue;let[n,s]=t.split("->").map((e=>e.trim())),a=(new DOMParser).parseFromString(m,"text/html"),d=a.querySelector(n),h=M(o,l,a,d);if(d)if(f)c(0,0,(()=>{u?.(r);for(let e of h){let t=document.createElement("script");t.textContent=e.textContent,r?.$?.append(t)}})),r?.$&&c(s?r?.$?.querySelector(s):r.$);else{document.body.append(d);for(let e of h){let t=document.createElement("script");for(let n of e.attributes)t.setAttribute(n.name,n.value);t.textContent=e.textContent,d.before(t)}}}let g=r?.$?.getAttribute("resolve"),b=w(g||"")?.func;b?.({$el:r,$st:t,$fn:e,$body:m}),f&&y(r?.$,n,l)};class v{$=null;m=new Map;M=new Set;L=!1;v=new Set;constructor(e,t){this.$=e;for(let e of t||[])this.v.add(e);window.MFLD.els.set(e,this)}addListener(e,t){this.m.set(e,t),this.$?.addEventListener(e,t)}addInternalStore(e){this.M.add(e)}cleanUp(){this.m.forEach(((e,t)=>{this.$?.removeEventListener(t,e)})),this.$?.remove(),this.$=null}}let D={},F=["bind","sync","get","head","post","put","delete","patch","promote"],S=(e,t)=>{t?D.profiles={...D.profiles,[t]:e}:D={...D,...e}};window.addEventListener("popstate",(()=>{location.reload()}));let k=(n,s)=>{if(!n||n?.nodeType==Node.TEXT_NODE)return;console.log("Registering",n);let o=n.querySelectorAll(`[${h}${F.join(`],[${h}`)}]`);for(let l of(s?.noparent?[...o]:[n,...o]).map((e=>window.MFLD.els.get(e)||new v(e,s?.fnCtx)))){if(s?.fnCtx?.length)for(let e of s?.fnCtx||[])l.v.add(e);if(l.L)continue;l.L=!0;let n=m(structuredClone(D),l.$);for(let o of l.$?.attributes||[]){if(!o.name.startsWith(h)||null===o.value)continue;let i=o.name.replace(h,"");if("promote"!=i)for(let s of l.$?.getAttribute(o.name)?.split(";;")||[""]){let r=!/bind|sync/.test(o.name),f=s?.split(/\s*->\s*/g),c=r&&f.pop()||"",a=r||"sync"==i?f.shift()?.match(/[^\(\)]{1,}/g)?.pop()?.split(p)?.map((e=>e.trim()))||[]:null,u=f?.[0]||"",{func:d,dependencyList:h}=w(u,Array.from(l.v)?.map((e=>`$${e.key}`))||[]);if(a)for(let s of a)if("sync"==i){let n=n=>{d?.({$el:l.$,$st:t,$fn:e}),y(l.$,n)};"$mount"===s?n():l.$?.addEventListener(s,n)}else b(l,s,n,c,i,d);else l.addInternalStore(g(l.$,d,h))}else{let[e,t,o,i]="A"==l.$?.tagName?["get",l.$.href,void 0,"click"]:[l.$.method?.toLowerCase(),l.$.action,()=>"$form","submit"];t&&b(l,i,n,t,e,o,(e=>k(e,{fnCtx:s?.fnCtx})))}}}};k(document.body);let _=["if","elseif","else","eval","each"],A="innerHTML",C=(e,t)=>{e[A]=t[A],t[A]=""};function x(n,s,o){let l,{func:i,as:r,dependencyList:f}=w(o||""),a=[],u=s.match(/if|else/);if(r=r||["$val","$key"],s.match(/else/)){let o=n,r=0;for(;o=o?.previousElementSibling;){let e="if";if(e=o.getAttribute("if")?"if":o.getAttribute("elseif")?"elseif":"",e&&a.push(o.M.get(e)?.name||""),r++>100){console.error("MFLD: No if start found");break}if(o.getAttribute("if"))break}f=[...f||[],...a],l=()=>{for(let e of a)if(t[e])return!1;return"else"==s||!0===i?.({$st:t,$fn:e})}}else l=i;let d=g(n,l,f,(o=>{if(void 0===o)return;let l=document.createElement("span");C(l,n),n.before(l),c(0,0,(()=>l.remove())),u&&!o||((e,t)=>{if(e instanceof Map)for(let[n,s]of e.entries())t(s,n);else try{let n=Array.isArray(e)?e:Array.from(e);if(n.length)n.forEach(t);else for(let n in e)t(e[n],n)}catch(t){console.error(`MFLD: ${e} is not iterable`)}})("each"==s?o:[o],((s,o)=>{let l=n.D?.cloneNode(!0);u||(l.innerHTML=l[A]?.replace(/{(\$[^}]*)}/g,((n,l)=>w(l,r.map((e=>`$${e}`))).func?.({$st:t,$fn:e,[`$${r[0]}`]:s,[`$${r[1]}`]:o})??""))||String(s)),n.append(l.content),c(0,0,(()=>k(n,{noparent:!0})))}))}));l&&n.F.add(l),n.M.set(s,d)}class N extends HTMLElement{D=null;F=new Set;M=new Map;connectedCallback(){this.D=this.querySelector("template")||(()=>{let e=document.createElement("template");return C(e,this),e})();let e="";for(let t of _){let n=this.getAttribute(t);null!=n&&(e&&console.error(`MFLD: Multiple templ statements '${e}' and '${t}'; '${e}' ignored`),e=t),null!==n&&x(this,t,n)}}disconnectedCallback(){this.F.forEach((e=>null))}static get observedAttributes(){return _}}window.templ||(window.templ=customElements.define("mf-templ",N));let T={make:(e,t)=>(t?.hasOwnProperty("value")||t?.hasOwnProperty("updater")||(t={value:t}),d(e,t)),untyped:(e,t)=>d(e,t),funcs:e=>{for(let t in e)MFLD.$fn[t]=e[t]}},E={make:(e,t)=>{MFLD.comp[e]||(MFLD.comp[e]=class extends HTMLElement{template=null;context=[];deps=new Set;onConnect;onAdopted;onDisconnect;onAttributeChanged;constructor(){super(),t?.onconstruct?.bind(this)?.(),this.onConnect=t?.onConnect?.bind(this),this.onAdopted=t?.onAdopted?.bind(this),this.onDisconnect=t?.onDisconnect?.bind(this),this.onAttributeChanged=t?.onAttributeChanged?.bind(this),this.template=document.getElementById(t?.selector||e)||document.createElement("template")}connectedCallback(){let e=this.attachShadow({mode:t?.shadow||"closed"}),n=this.template.content.cloneNode(!0);for(let e of this.attributes){let{func:t,dependencyList:n}=w(e.value);if(t){for(let e of n||[])this.deps.add(e);this.context.push({key:e.name,func:t})}}if(n){e.append(n);for(let t of Array.from(e.children))if(console.log("FOUND CHILD",t),"SLOT"==t.nodeName)for(let e of t.assignedNodes())k(e,{fnCtx:this.context});else"TEMPLATE"!=t.nodeName&&k(t,{fnCtx:this.context})}}attributeChangedCallback=this.onAttributeChanged;disconnectedCallback=this.onDisconnect;adoptedCallback=this.onAdopted;static get observedAttributes(){return t?.observedAttributes||[]}},MFLD.comp[e]&&customElements.define(e,MFLD.comp[e]))},register:async e=>{await L(void 0,"get",{fetch:{externals:[{domain:"$origin",script:"all",style:"selected"}]}},e,"template -> body",null,!1)}};export{e as $fn,t as $st,E as component,S as config,i as onTick,T as store};
