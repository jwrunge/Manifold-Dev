window.MFLD||(window.MFLD={st:new Map,els:new Map,$st:new Proxy(d,{get:(e,t)=>"string"==typeof t?e(t)?.value:void 0,set:(e,t,n)=>{if("string"==typeof t){let s=t.split(/[\.\[\]\?]{1,}/g).map((e=>parseFloat(e.trim())||e.trim())),l=e(s[0]),o=l.value;for(let e of s.slice(1)||[])o=o[e];o=n,l.update(o)}return!0}}),$fn:{},comp:{}});let{$fn:e,$st:t}=MFLD,n=[],s=new Set,l=0,o=[],i=e=>{e&&o.push(e)},r=e=>{"function"==typeof e?n.push(e):s.add(e),l||(l=requestAnimationFrame((()=>f())))};function f(i=0){if(i||console.log("%cRunning batched updates","background: yellow; color: red;",performance.now()),i>100)return void console.error("MFLD: Recursion limit reached - check for circular references.");l=0,i++;for(let e of n)e();let r=new Set;for(let n of s){let l=!1;for(let e of n.t)if(s.has(e)){l=!0;break}if(l)r.add(n);else{let s=n.l?.({$st:t,$fn:e,$el:n.o});n.update(void 0===s?n.value:s)}}n=[],s.clear(),r.size?(s=r,f(i)):(s.size&&f(i),o.forEach((e=>e())),o=[])}function a(e,t,n){r((()=>{n?.()}))}function c(e){if(!e||!isNaN(e)||!0===e)return e;if(e instanceof Map||e instanceof Set)return c(Array.from(e.entries()||e));let t=0;for(let n of(new TextEncoder).encode(e?.toString()||""))t=(t<<5)-t+n;return t}class u{l;i=new Set;u;t=new Set;h=new Set;o;name;value;constructor(e,t){this.name=e,MFLD.st.set(e,this),this.o=t?.scope,this.value="function"!=typeof t?.value?t?.value:void 0,this.p(t)}p(e){return e?.dependencyList?.map((e=>{let t=d(e);return this.t.add(t),t.h.add(this),t})),this.value=e?.value,this.l=e?.updater,r(this),this}sub(e,t=!0){this.i.add(e),t&&e(this.value)}update(e){setTimeout((()=>{let t="function"==typeof e?e(this.value):e,n=c(t);if(n!==this.u){this.value=t,this.u=n;for(let e of this.h)r(e);for(let e of Array.from(this.i))e(this.value)}}),0)}}function d(e,t){let n=MFLD.st.get(e);return t?n?n.p(t):new u(e,t):n||new u(e,t)}let h="mf-",p=/, {0,}/g,$=()=>`${Date.now()}.${Math.floor(1e5*Math.random())}`,m=(e,t)=>{let n=e.profiles?.[t.getAttribute("override")||""],s={...e,...n};for(let e in t?.attributes||[])for(let n of["fetch","trans"])if(e.startsWith(`${h}${n}_`))try{let l=e.split("_")[2],o=t.getAttribute(n);o?.match(/\{|\[/)?o=JSON.parse(o):parseInt(o||"")&&(o=parseInt(o)),Array.isArray(o)&&(o=o.map((e=>parseInt(e)||e))),s?.[n]?.[l]&&(s[n][l]=o)}catch(e){console.error(e)}return s},w=(e,t="$val",n="$key",s=[])=>{try{let[l,o]=e?.split(/\s{1,}as\s{1,}/)||[e,"value"],i=l?.match(/^\s{0,}(function)?\(.{0,}\)(=>)?\s{0,}/)?`(${l})()`:l,r=`let {$el, $st, $fn, ${t}, ${n}, $body, ${s.join(",")}} = ops;return ${i}`,f=o?.split?.(p)?.map?.((e=>e.trim()))||["value"]||[],a=Array.from(new Set([...l?.matchAll(/\$st\.(\w{1,})/g)].map((e=>e[1]))));return i?{func:new Function("ops",r),as:f,dependencyList:a}:{}}catch(e){return console.error(e),{}}};function y(e,t,n){t?.preventDefault();let s=e?.getAttribute("pushstate"),l=n;switch(s){case"":break;case void 0:return;default:l=`#${s}`}history.pushState(null,"",l)}function b(n,s,l,o){let i=d($(),{updater:()=>s?.({$el:n,$st:t,$fn:e}),dependencyList:l,internal:!0});return o&&i.sub(o),i}let g=(e,t,n,s,l,o,i)=>{let r=t=>L(t,l,n,s,null,e,!0,o,i);"$mount"===t?r():e.addListener(t,r)},M=(e,t,n,s)=>{let l=e.fetch?.externals?.find((e=>"$origin"===e.domain&&(t.startsWith(location.origin)||!t.match(/^(https?):\/\//))||t.startsWith(e.domain)));l||(l=t.startsWith(location.origin)?{domain:"$origin",script:"selected",style:"selected"}:void 0);let[o,i]=["style","script"].map((e=>Array.from(("all"==l?.[e]?n:s)?.querySelectorAll(e))));if("all"===l?.style)o.forEach((e=>s?.append(e)));else o.forEach((e=>e.parentNode?.removeChild(e)));for(let e of i)e.parentNode?.removeChild(e);return i},L=async(n,s,l,o,i,r,f,c,u)=>{n?.preventDefault();let d=c?c({$el:r,$st:t,$fn:e}):void 0,h="$form"===d?new FormData(r?.$):d,p=await fetch(o,{...l.fetch?.request||{},headers:{...l.fetch?.request?.headers,MFLD:"true"},method:s||n?.target?.method||"get",body:"$form"===d||"string"==typeof h?h:JSON.stringify(h)}).catch((e=>{l.fetch?.err?.(e)})),$=p?.status,m=await(p?.[l.fetch?.resType||"text"]());if($&&!1===l.fetch?.onCode?.($,p))return;for(let e of i?[""]:["append","prepend","insert","replace"]){let t=i||r?.$?.getAttribute(e);if(null==t)continue;let[n,s]=t.split("->").map((e=>e.trim())),c=(new DOMParser).parseFromString(m,"text/html"),d=c.querySelector(n),h=M(l,o,c,d);if(d)if(f)a(0,0,(()=>{u?.(r);for(let e of h){let t=document.createElement("script");t.textContent=e.textContent,r?.$?.append(t)}})),r?.$&&a(s?r?.$?.querySelector(s):r.$);else{document.body.append(d);for(let e of h){let t=document.createElement("script");for(let n of e.attributes)t.setAttribute(n.name,n.value);t.textContent=e.textContent,d.before(t)}}}let b=r?.$?.getAttribute("resolve"),g=w(b||"")?.func;g?.({$el:r,$st:t,$fn:e,$body:m}),f&&y(r?.$,n,o)};class v{$=null;m=new Map;M=new Set;L=!1;constructor(e){this.$=e,window.MFLD.els.set(e,this)}addListener(e,t){this.m.set(e,t),this.$?.addEventListener(e,t)}addInternalStore(e){this.M.add(e)}cleanUp(){this.m.forEach(((e,t)=>{this.$?.removeEventListener(t,e)})),this.$?.remove(),this.$=null}}let k={},F=["bind","sync","get","head","post","put","delete","patch","promote"],D=(e,t)=>{t?k.profiles={...k.profiles,[t]:e}:k={...k,...e}};window.addEventListener("popstate",(()=>{location.reload()}));let S=(n,s=!1,l,o)=>{if(!n||n?.nodeType==Node.TEXT_NODE)return;let i=n.querySelectorAll(`[${h}${F.join(`],[${h}`)}]`);for(let l of(s?[...i]:[n,...i]).map((e=>window.MFLD.els.get(e)||new v(e)))){if(l.L)continue;l.L=!0;let n=m(structuredClone(k),l.$);for(let s of l.$?.attributes||[]){if(!s.name.startsWith(h)||null===s.value)continue;let o=s.name.replace(h,"");if("promote"!=o)for(let i of l.$?.getAttribute(s.name)?.split(";;")||[""]){let r=!/bind|sync/.test(s.name),f=i?.split(/\s*->\s*/g),a=r&&f.pop()||"",c=r||"sync"==o?f.shift()?.match(/[^\(\)]{1,}/g)?.pop()?.split(p)?.map((e=>e.trim()))||[]:null,u=f?.[0]||"",{func:d,dependencyList:h}=w(u);if(c)for(let s of c)if("sync"==o){let n=n=>{d?.({$el:l.$,$st:t,$fn:e}),y(l.$,n)};"$mount"===s?n():l.$?.addEventListener(s,n)}else g(l,s,n,a,o,d);else l.addInternalStore(b(l.$,d,h))}else{let[e,t,s,o]="A"==l.$?.tagName?["get",l.$.href,void 0,"click"]:[l.$.method?.toLowerCase(),l.$.action,()=>"$form","submit"];t&&g(l,o,n,t,e,s,(e=>S(e)))}}}};S(document.body);let _=["if","elseif","else","eval","each"],A="innerHTML",C=(e,t)=>{e[A]=t[A],t[A]=""};function x(n,s,l){let o,{func:i,as:r,dependencyList:f}=w(l||""),c=[],u=s.match(/if|else/);if(r=r||["$val","$key"],s.match(/else/)){let l=n,r=0;for(;l=l?.previousElementSibling;){let e="if";if(e=l.getAttribute("if")?"if":l.getAttribute("elseif")?"elseif":"",e&&c.push(l.M.get(e)?.name||""),r++>100){console.error("MFLD: No if start found");break}if(l.getAttribute("if"))break}f=[...f||[],...c],o=()=>{for(let e of c)if(t[e])return!1;return"else"==s||!0===i?.({$st:t,$fn:e})}}else o=i;let d=b(n,o,f,(l=>{if(void 0===l)return;let o=document.createElement("span");C(o,n),n.before(o),a(0,0,(()=>o.remove())),u&&!l||((e,t)=>{if(e instanceof Map)for(let[n,s]of e.entries())t(s,n);else try{let n=Array.isArray(e)?e:Array.from(e);if(n.length)n.forEach(t);else for(let n in e)t(e[n],n)}catch(t){console.error(`MFLD: ${e} is not iterable`)}})("each"==s?l:[l],((s,l)=>{let o=n.v?.cloneNode(!0);u||(o.innerHTML=o[A]?.replace(/\$:{([^}]*)}/g,((n,o)=>w(o,r[0],r[1]).func?.({$st:t,$fn:e,[r[0]]:s,[r[1]]:l})??""))||String(s)),n.append(o.content),a(0,0,(()=>S(n,!0,r[1],r[0])))}))}));o&&n.k.add(o),n.M.set(s,d)}class T extends HTMLElement{v=null;k=new Set;M=new Map;connectedCallback(){this.v=this.querySelector("template")||(()=>{let e=document.createElement("template");return C(e,this),e})();let e="";for(let t of _){let n=this.getAttribute(t);null!=n&&(e&&console.error(`MFLD: Multiple templ statements '${e}' and '${t}'; '${e}' ignored`),e=t),null!==n&&x(this,t,n)}}disconnectedCallback(){this.k.forEach((e=>null))}static get observedAttributes(){return _}}window.templ||(window.templ=customElements.define("mf-templ",T));let E={make:(e,t)=>(t?.hasOwnProperty("value")||t?.hasOwnProperty("updater")||(t={value:t}),d(e,t)),untyped:(e,t)=>d(e,t),funcs:e=>{for(let t in e)MFLD.$fn[t]=e[t]}},N={make:(e,t)=>{MFLD.comp[e]||(MFLD.comp[e]=class extends HTMLElement{template=null;onconnect;onadopted;ondisconnect;onAttributeChanged;constructor(){super(),t?.onconstruct?.bind(this)?.(),this.onconnect=t?.onconnect?.bind(this),this.onadopted=t?.onadopted?.bind(this),this.ondisconnect=t?.ondisconnect?.bind(this),this.onAttributeChanged=t?.onAttributeChanged?.bind(this),this.template=document.getElementById(t?.selector||e)||document.createElement("template")}connectedCallback(){let e=this.attachShadow({mode:t?.shadow||"closed"}),n=this.template.content.cloneNode(!0);if(n){e.append(n);for(let t of Array.from(e.children))if("SLOT"==t.nodeName)for(let e of t.assignedNodes())S(e);else"TEMPLATE"!=t.nodeName&&S(t)}}attributeChangedCallback=this.onAttributeChanged;disconnectedCallback=this.ondisconnect;adoptedCallback=this.onadopted;static get observedAttributes(){return t?.observedAttributes||[]}},MFLD.comp[e]&&customElements.define(e,MFLD.comp[e]))},register:async e=>{await L(void 0,"get",{fetch:{externals:[{domain:"$origin",script:"all",style:"selected"}]}},e,"template -> body",null,!1)}};export{e as $fn,t as $st,N as component,D as config,i as onTick,E as store};
