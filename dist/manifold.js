window.MFLD||(window.MFLD={st:new Map,mut:new Map,$st:new Proxy($,{get:(t,e)=>"string"==typeof e?t(e)?.value:void 0,set:(t,e,s)=>{if("string"==typeof e){let i=e.split(/[\.\[\]\?]{1,}/g).map((t=>parseFloat(t.trim())||t.trim())),n=t(i[0]),o=n.value;for(let t of i.slice(1)||[])o=o[t];o=s,n.update(o)}return!0}}),$fn:{},comp:{}});let{$fn:t,$st:e}=MFLD,s=[],i=0,n=[],o=t=>{s.push(t),i||(i=requestAnimationFrame(r))},r=()=>{i=0;for(let t of s)if("function"!=typeof t){if("prepend"==t.relation)t.in.t("in",(()=>t.in&&t.out?.i(t.in.o,"prepend",!1)));else{if(["inner","outer"].includes(t.relation)){let e=t.out?.i(t.out?.o,"after");"inner"==t.relation&&(e.style.border="none",t?.out?.l()),t.out.t("out")}t.in.t("in",(()=>{"outer"==t.relation?t.out?.h(t.in):t.out?.i(t.in.o,"appendChild",!1)}))}t.done?.(t.in)}else t();n.forEach((t=>t())),n=[],s=[]},l="mf_",a=/, {0,}/g,h=()=>`${Date.now()}.${Math.floor(1e5*Math.random())}`,u=(t,e)=>{let s=t.profiles?.[e.u("override")||""],i={...t,...s};for(let t in e.p())for(let s of["fetch","trans"])if(t.startsWith(`${l}${s}_`))try{let n=t.split("_")[2],o=e.u(t);o?.match(/\{|\[/)?o=JSON.parse(o):parseInt(o||"")&&(o=parseInt(o)),Array.isArray(o)&&(o=o.map((t=>parseInt(t)||t))),i[s][n]=o}catch(t){console.error(t)}return i},c=(t,e="$val",s="$key")=>{try{console.log(t,t?.split(/\s{1,}as\s{1,}/)||[t,"value"]);let[i,n]=t?.split(/\s{1,}as\s{1,}/)||[t,"value"],o=i?.match(/^\s{0,}(function)?\(.{0,}\)(=>)?\s{0,}/)?`(${i})()`:i,r=`let {$cur, $el, $st, $fn, ${e}, ${s}, $body} = ops;return ${o}`,l=n?.split?.(a)?.map?.((t=>t.trim()))||["value"]||[],h=Array.from(new Set([...i?.matchAll(/\$st\.(\w{1,})/g)].map((t=>t[1]))));return o?{func:new Function("ops",r),as:l,dependencyList:h}:{}}catch(t){return console.error(t),{}}};function f(t,e,s){e?.preventDefault();let i=t?.u("pushstate"),n=s;switch(i){case"":break;case void 0:return;default:n=`#${i}`}history.pushState(null,"",n)}function d(t){if(!t||!isNaN(t)||!0===t)return t;if(t instanceof Map||t instanceof Set)return d(Array.from(t.entries()||t));let e=0;for(let s of(new TextEncoder).encode(t?.toString()||""))e=(e<<5)-e+s;return e}class p{$;m=new Map;_;v=new Set;M=new Set;L;F;name;value;constructor(t,e){this.name=t,MFLD.st.set(t,this),this.L=e?.scope,this.value="function"!=typeof e?.value?e?.value:void 0,this.T(e)}T(t){let{func:e,dependencyList:s}=c((t?.updater||"function"==typeof t?.value?t?.value:null)?.toString()||"");return s?.map((t=>{let e=$(t);return this.v.add(e),e.M.add(this),e})),this.value=t?.value,this.$=e,this.D(),this}sub(t,e,s=!0){this.m.set(e||h(),t),s&&t(this.value)}update(t){this.F&&clearTimeout(this.F),this.F=setTimeout((()=>{o((()=>{let e="function"==typeof t?t(this.value):t,s=d(e);if(s!==this._){this.value=e,this._=s.toString();for(let t of this.M)t.D();for(let[t,e]of this.m)e(this.value,t)}return this.value}))}),0)}D(){let s=this.$?.({$cur:this.value,$st:e,$fn:t,$el:this.L?.o});this.update(void 0===s?this.value:s)}}function $(t,e){let s=MFLD.st.get(t);return e?s?s.T(e):new p(t,e):s||new p(t,e)}let m=new WeakMap;class y{o;S=new Map;A=new Set;k;constructor(t){return t.element?this.o=t.element:t.query?this.o=(t.parent||document).querySelector(t.query):this.o=document.createElement(t.create||"TEMPLATE"),m.get(this.o)?.C(),m.set(this.o,this),this.q(["_mfld",...t.classes||[]]),this.k=t.ops,this}p(){return this.o?.dataset||{}}u(t,e){e&&(this.o.dataset[`${l}${t}`]=e);let s=this.o?.dataset[`${l}${t}`];return s||void 0!==s?"T":""}q(t,e=!1){t instanceof Array&&(t=[t]);for(let s of t)this.o.classList[e?"remove":"add"]?.(s)}N(t,e=!0){return this.o["querySelector".concat(e?"All":"")](t)}O(t,e){return this.S?.set(t,e),e}I(t){return this.A?.add(t),t}P(t,e,s,i){return t?.({$el:this.o,$st:F,$fn:T,key:e,val:s,body:i})}H(t){let e=h();return this.u("cstore",e),$(e,{upstream:t,updater:()=>func?.({$el:$el,$st:F,$fn:T})})}i(t,e="append",s=!0){let i=s?t.cloneNode(!0):t;return this.o[e]?.(i),i}l(){this.o.replaceChildren()}h(t){this.o?.replaceWith(t.o),this.C()}J(t=[]){let e=new y({classes:t,ops:this.k});return e.i(this.o),this.h(e),e}W(){let t=this.o,e=getComputedStyle(t),s=t.getBoundingClientRect();return{w:`calc(${t.clientWidth}px - ${e.paddingLeft} - ${e.paddingRight})`,left:`calc(${s.left}px + ${window.scrollX}px)`,top:`calc(${s.top}px + ${window.scrollY}px)`}}t(t,e,s){let i=this.k,n=i.trans?.dur?.["in"==t?"shift":"pop"]?.()||0;n&&(this.o.style.transitionDuration=`${n}ms`);let r=i?.trans?.class||`${l}trans`;i.trans?.hooks?.[`${t}-start`]?.(this.o),"out"==t?o((()=>{let t;this.q("out"),(i.trans?.smart??1)&&(t=this.W(),Object.assign(this.o.style,{position:"fixed",width:t.w,left:t.left,top:t.top,margin:"0"}))})):(this.q("in"),e?.(),setTimeout((()=>{o((()=>{setTimeout((()=>o((()=>this.q(t,!0)))),0)}))}),i.trans?.swap||0)),setTimeout((()=>{o((()=>{"out"==t?this.C():this.q(r,!0),i.trans?.hooks?.[`${t}-end`]?.(this.o),this.o.style.transitionDuration="","in"==t&&s?.(this)}))}),n+("in"==t&&i.trans?.swap||0))}C(){this.S?.forEach(((t,e)=>{this.o?.removeEventListener(e,t)})),this.A?.forEach((t=>{this.A?.delete(t)})),this.N("._mfld",!0)?.forEach((t=>{m.get(t)?.C()})),this.o.remove(),this.A=this.S=this.o=null,this.o&&m.delete(this.o)}}let w=(t,e,s,i,n,o,r)=>{let l=e=>_(e,n,s,i,t,!0,o,r);"$mount"===e?l():t.O(e,l)},_=async(s,i,n,r,l,a,h,u)=>{s?.preventDefault(),s?.stopPropagation(),i||(i=s?.target?.method||"get");let d=n.fetch?.externals?.find((t=>"$origin"===t.domain&&(r.startsWith(location.origin)||!r.match(/^(https?):\/\//))||r.startsWith(t.domain)));d||(d=r.startsWith(location.origin)?{domain:"$origin",scripts:"selected",styles:"selected"}:void 0);let p=h?h({$el:l,$st:e,$fn:t}):void 0,$="$form"===p?new FormData(l.o):p,m=await fetch(r,{...n.fetch?.request||{},headers:{...n.fetch?.request?.headers,MFLD:"true"},method:i,body:"$form"===p||"string"==typeof $?$:JSON.stringify($)}).catch((t=>{n.fetch?.err?.(t)})),w=m?.status;if(w&&!1===n.fetch?.onCode?.(w,m))return;let _=await(m?.[n.fetch?.resType||"text"]());for(let t of["append","prepend","inner","outer"]){let e=l.u(t);if(!e)continue;let[s,i]=e.split("->").map((t=>t.trim())),r=(new DOMParser).parseFromString(_,"text/html"),h=new y({parent:r,query:s||"body",ops:n});if(r){let e=[];if(d?.styles&&"none"!==d.styles||r.querySelectorAll("style").forEach((t=>t.parentNode?.removeChild(t))),"all"===d?.styles&&r.querySelectorAll("style").forEach((t=>h?.i(t,"append",!1))),("all"===d?.scripts?r:h.o)?.querySelectorAll("script").forEach((t=>{["all","selected"].includes(d?.scripts||"")&&e.push(t),t.parentNode?.removeChild(t)})),h)if(a)o({in:h,out:i?new y({query:i,ops:n}):l,relation:t,ops:n,done:t=>{u?.(t);for(let s of e){let e=document.createElement("script");e.textContent=s.textContent,t?.i(e,"append",!1)}}});else{document.body.appendChild(h.o);for(let t of e){let e=document.createElement("script");for(let s of t.attributes)e.setAttribute(s.name,s.value);e.textContent=t.textContent,h.o.before(e)}}}}let g=l.u("resolve"),v=c(g||"")?.func;v?.({$el:l,$st:e,$fn:t,$body:_}),a&&f(l,s,r)},g=(s,i,n)=>{let o=i=>{n?.({$el:s.o,$st:e,$fn:t}),i&&f(s,i)};"$mount"===i?o():s.O(i,o)},v={},M=["bind","sync","templ","if","elseif","else","each","get","head","post","put","delete","patch","promote"].map((t=>`${l}${t}`));window.addEventListener("popstate",(()=>{location.reload()}));let b=t=>{if(t?.nodeType==Node.TEXT_NODE)return;let e=(t||document.body).querySelectorAll(`[data-${M.join("],[data-")}],a,form`);for(let s of[t,...e].map((t=>new y({element:t,ops:v})))){let t=u(structuredClone(v),s);if(s.u?.("promote")){let[e,i,n,o]="A"==s.o.tagName?["get",s.o.href,void 0,"click"]:[s.o.method.toLowerCase(),s.o.action,()=>"$form","submit"];if(i){w(s,o,t,i,e,n,(t=>b(t)));continue}}for(let e in s?.p())if(M.includes(e))for(let i of s.u(e)?.split(";;")||[]){let n=!!/get|head|post|put|delete|patch/.test(e),o=i?.split(/\s*->\s*/g),r=n&&o.pop()||"",h=n||/sync/.test(e)?o.shift()?.match(/[^\(\)]{1,}/g)?.pop()?.split(a)?.map((t=>t.trim())):[]||[],u=o?.[0]||"",{func:f,as:d,dependencyList:p}=c(u);if(/each|templ|if|else/.test(e));else{h?.length||(h=[""]);for(let i of h)/bind/.test(e)||(/sync/.test(e)?g(s,i,f):w(s,i,t,r,e.replace(l,""),f))}}}},L={store:(t,e)=>(e?.hasOwnProperty("value")||e?.hasOwnProperty("updater")||(e={value:e}),$(t,e)),ustore:(t,e)=>$(t,e),funcs:t=>{for(let e in t)MFLD.$fn[e]=t[e]},config:(t,e)=>{return s=t,void((i=e)?v.profiles={...v.profiles,[i]:s}:v={...v,...s});var s,i},onTick:t=>{var e;(e=t)&&n.push(e)},register:t=>b("string"==typeof t?document.querySelector(t):t),makeComponent:(t,e)=>{MFLD.comp[t]=class extends HTMLElement{template=null;onconnect;onadopted;ondisconnect;onAttributeChanged;constructor(){super(),e?.onconstruct?.bind(this)?.(),this.onconnect=e?.onconnect?.bind(this),this.onadopted=e?.onadopted?.bind(this),this.ondisconnect=e?.ondisconnect?.bind(this),this.onAttributeChanged=e?.onAttributeChanged?.bind(this),this.template=new y({ops:e?.options||{},element:e?.templ||document.getElementById(e?.selector||t)})}connectedCallback(){let t=this.attachShadow({mode:e?.shadow||"closed"}),s=(this.template?.o).content.cloneNode(!0);if(s){t.append(s);for(let e of Array.from(t.children))if("SLOT"==e.nodeName)for(let t of e.assignedNodes())b(t);else"TEMPLATE"!=e.nodeName&&b(e)}}attributeChangedCallback(t,e,s){this.onAttributeChanged?.(t,e,s)}disconnectedCallback(){this.ondisconnect?.()}adoptedCallback(){this.onadopted?.()}static get observedAttributes(){return e?.observedAttributes||[]}},MFLD.comp[t]&&customElements.define(t,MFLD.comp[t])},component:async t=>{}},F=MFLD.$st,T=MFLD.$fn;export{T as $fn,F as $st,L as Mfld};
