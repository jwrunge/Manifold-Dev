window.MFLD||(window.MFLD={st:new Map,mut:new Map,$st:new Proxy(c,{get:(e,t)=>"string"==typeof t?e(t)?.value:void 0,set:(e,t,s)=>{if("string"==typeof t){let n=t.split(/[\.\[\]\?]{1,}/g).map((e=>parseFloat(e.trim())||e.trim())),i=e(n[0]),o=i.value;for(let e of n.slice(1)||[])o=o[e];o=s,i.update(o)}return!0}}),$fn:{},comp:{}});let{$fn:e,$st:t}=MFLD,s=[],n=new Set,i=0,o=[],l=e=>{"function"==typeof e?s.push(e):n.add(e),i||(i=requestAnimationFrame(r))};function r(l,f=0){if(0==f?console.log("RUNNING UPDATES"):console.log("RECURSING",f),f>100)return void console.error("MFLD: Recursion limit reached - check for circular refrences.");i=0;for(let e of s)e();let a=new Set;for(let s of n){let i=!1;for(let e of s.t)if(n.has(e)){i=!0;break}if(i)a.add(s);else{let n=s.i?.({$cur:s.value,$st:t,$fn:e,$el:s.l?.o});s.update(void 0===n?s.value:n),console.log("Updating",s.name)}}s=[],n.clear(),a.size?(n=a,r(0,f+1)):(n.size&&r(0,f+1),o.forEach((e=>e())),o=[])}function f(e){if(!e||!isNaN(e)||!0===e)return e;if(e instanceof Map||e instanceof Set)return f(Array.from(e.entries()||e));let t=0;for(let s of(new TextEncoder).encode(e?.toString()||""))t=(t<<5)-t+s;return t}class a{i;u=new Set;h;t=new Set;p=new Set;l;$;name;value;constructor(e,t){this.name=e,MFLD.st.set(e,this),this.l=t?.scope,this.value="function"!=typeof t?.value?t?.value:void 0,this.m(t)}m(e){return e?.dependencyList?.map((e=>{let t=c(e);return this.t.add(t),t.p.add(this),t})),this.value=e?.value,this.i=e?.updater,this.T(),this}sub(e,t=!0){this.u.add(e),t&&e(this.value)}update(e){this.$&&clearTimeout(this.$),this.$=setTimeout((()=>{let t="function"==typeof e?e(this.value):e,s=f(t);if(s!==this.h){this.value=t,this.h=s,console.log("CHANGE DETECTED -- broadcasting",this.name,s,this.h);for(let e of this.p)e.T();for(let e of Array.from(this.u))e(this.value)}return this.value}),0)}T(){l(this)}}function c(e,t){let s=MFLD.st.get(e);return t?s?s.m(t):new a(e,t):s||new a(e,t)}let u="data-mf-",h=/, {0,}/g,d=()=>`${Date.now()}.${Math.floor(1e5*Math.random())}`,p=(e,t)=>{let s=e.profiles?.[t._("override")||""],n={...e,...s};for(let e of t.o?.attributes||[])for(let t of["fetch","trans"]){let s=e.name;if(s.startsWith(`${u}${t}_`))try{let i=s.split("_")[2],o=e.value;o?.match(/\{|\[/)?o=JSON.parse(o):parseInt(o||"")&&(o=parseInt(o)),Array.isArray(o)&&(o=o.map((e=>parseInt(e)||e))),n?.[t]?.[i]&&(n[t][i]=o)}catch(e){console.error(e)}}return n},$=(e,t="$val",s="$key")=>{try{let[n,i]=e?.split(/\s{1,}as\s{1,}/)||[e,"value"],o=n?.match(/^\s{0,}(function)?\(.{0,}\)(=>)?\s{0,}/)?`(${n})()`:n,l=`let {$cur, $el, $st, $fn, ${t}, ${s}, $body} = ops;return ${o}`,r=i?.split?.(h)?.map?.((e=>e.trim()))||["value"]||[],f=Array.from(new Set([...n?.matchAll(/\$st\.(\w{1,})/g)].map((e=>e[1]))));return o?{func:new Function("ops",l),as:r,dependencyList:f}:{}}catch(e){return console.error(e),{}}};function m(e,t,s){t?.preventDefault?.();let n=e?._("pushstate"),i=s;switch(n){case"":break;case void 0:return;default:i=`#${n}`}history.pushState(null,"",i)}let w=new Map,y=(e,t,s,n,i)=>{(w.get(e)||new E("TRANSITION "+t,{element:e,ops:s}))?.M(t,n,i)};class E{o;L=new Map;S=new Set;v;constructor(e,t){let s;return s=t.element?t.element:t.query?(t.parent||document).querySelector(t.query):document.createElement(t.create||"TEMPLATE"),this.o=s,w.get(this.o)?.A(!1),w.set(this.o,this),this.N(["_mfld",...t.classes||[]]),t.C&&t.C.ref.C(s,t.C.mode,!1),this.v=t.ops,this}_(e,t){t&&this.o?.setAttribute(`${u}${e}`,t);let s=this.o?.getAttribute(`${u}${e}`);return s??null}N(e,t=!1){for(let s of e)this.o?.classList[t?"remove":"add"]?.(s)}F(e,t=!0){return this.o?.["querySelector".concat(t?"All":"")](e)}D(s,n){let i=()=>n({$el:this.o,$st:t,$fn:e});this.o?.addEventListener(s,i),this.L?.set(s,i)}I(e){return e&&this.S?.add(e),e}k(s,n,i){let o=d();this._("cstore",o),this.I(s);let l=c(o,{updater:()=>s?.({$el:this.o,$st:t,$fn:e}),dependencyList:n,scope:this});return i&&(this.I(i),l.sub(i)),l}C(e,t="append",s=!0){let n=s?e.cloneNode(!0):e;return this.o?.[t]?.(n),n}R(e){this.o?.replaceWith(e.o),this.A()}O(e=[]){if("TEMPLATE"==this.o?.tagName)return this.N(e),this;let t=new E("As TeMPL",{classes:e,ops:this.v,C:{ref:this}});return t.o.content?.append(this.o.cloneNode(!0)),this.R(t),t}P(){let e=this.o,t=getComputedStyle(e),s=e.getBoundingClientRect();return{w:`calc(${e.clientWidth}px - ${t.paddingLeft} - ${t.paddingRight})`,left:`calc(${s.left}px + ${window.scrollX}px)`,top:`calc(${s.top}px + ${window.scrollY}px)`}}M(e,t,s){l((()=>{"out"==e&&this.A(),s?.()}))}A(e=!0){this.L?.forEach(((e,t)=>{this.o?.removeEventListener(t,e)})),this.S?.forEach((e=>{this.S?.delete(e)})),this.F("._mfld",!0)?.forEach((e=>{w.get(e)?.A()})),this.S=this.L=null,e&&this.o.remove(),w.delete(this.o)}}let T=(e,t,s,n,i,o,l)=>{let r=t=>_(t,i,s,n,e,!0,o,l);"$mount"===t?r():e.D(t,r)},_=async(s,n,i,o,l,r,f,a)=>{s?.preventDefault(),s?.stopPropagation(),n||(n=s?.target?.method||"get");let c=i.fetch?.externals?.find((e=>"$origin"===e.domain&&(o.startsWith(location.origin)||!o.match(/^(https?):\/\//))||o.startsWith(e.domain)));c||(c=o.startsWith(location.origin)?{domain:"$origin",script:"selected",style:"selected"}:void 0);let u=f?f({$el:l,$st:t,$fn:e}):void 0,h="$form"===u?new FormData(l.o):u,d=await fetch(o,{...i.fetch?.request||{},headers:{...i.fetch?.request?.headers,MFLD:"true"},method:n,body:"$form"===u||"string"==typeof h?h:JSON.stringify(h)}).catch((e=>{i.fetch?.err?.(e)})),p=d?.status;if(p&&!1===i.fetch?.onCode?.(p,d))return;let w=await(d?.[i.fetch?.resType||"text"]());for(let e of["append","prepend","inner","outer"]){let t=l._(e);if(null==t)continue;let[s,n]=t.split("->").map((e=>e.trim())),o=(new DOMParser).parseFromString(w,"text/html"),r=new E("FETCH IN EL",{parent:o,query:s||"body",ops:i}),[f,u]=["style","script"].map((e=>Array.from(("all"==c?.[e]?o:r.o)?.querySelectorAll(e))));if("all"===c?.style)f.forEach((e=>r?.C(e,"append",!1)));else f.forEach((e=>e.parentNode?.removeChild(e)));for(let e of u)e.parentNode?.removeChild(e);r&&r.M("in",null,(()=>{a?.(l);for(let e of u){let t=document.createElement("script");t.textContent=e.textContent,l?.o?.append(t)}})),(n?new E("FETCH OUTEL",{query:n,ops:i}):l).M("out")}let y=l._("resolve"),T=$(y||"")?.func;T?.({$el:l,$st:t,$fn:e,$body:w}),r&&m(l,s,o)},b=(e,t,s,n=!1)=>{let i=n?"previousElementSibling":"nextElementSibling";return!e||t?.(e)?e:b(s?.(e)||e?.[i],t,s,n)},g=(e,t)=>{if(e instanceof Map)for(let[s,n]of e.entries())t(n,s);else try{let s=Array.isArray(e)?e:Array.from(e);if(s.length)s.forEach(t);else for(let s in e)t(e[s],s)}catch(t){console.error(`${e} is not iterable`)}},M=(s,n,i,o,r,f)=>{let a,c=s.O([`${n}-end`]),h=n.match(/if|else/),d=n.match(/else/),p=[];if(!h||"if"==n){let e=document.createElement("template");e.classList.add(`${n}-start`),c.C(e,"before")}h&&(b(c.o,(e=>e?.classList?.contains("if-start")),(e=>{let t=e?.getAttribute(`${u}cstore`);t&&p.push(t)}),!0),a=c.I((()=>{if(d)for(let e of p)if(t[e]&&console.log(n,"RETURNING FALSE BASED ON CONDITION",e),t[e])return!1;return console.log(n,"else"==n?"RETURNING IMPLICIT TRUE":"RETURNING "+(!0===o?.({el:s,$st:t,$fn:e}))),"else"==n||!0===o?.({el:s,$st:t,$fn:e})})));c.k(h?a:o,[...r,...p],(r=>{void 0!==r&&(h&&!r||l((()=>{let a=b(c.o.previousElementSibling,(e=>e?.classList?.contains("if-start")),(e=>{"TEMPLATE"!=e?.nodeName&&y(e,"out",f,o)}),!0);l((()=>{let o=a?.nextElementSibling;g("each"==n?r:[r],((n,l)=>{let r=c.o.cloneNode(!0);if(!h){let o=c.o.innerHTML.replace(/\$:{([^}]*)}/g,((o,r)=>$(r,i[0],i[1]).func?.({$el:s,$st:t,$fn:e,[i[0]]:n,[i[1]]:l})||""))||"";r.innerHTML&&(r.innerHTML=o)}for(let e of Array.from(r.content.children))e.innerHTML||(e.innerHTML=String(n)),o.before(e),y(e,"in",f)}))}))})))}))},L={},S=["bind","sync","templ","if","elseif","else","each","get","head","post","put","delete","patch","promote"];window.addEventListener("popstate",(()=>{location.reload()}));let v=(s,n=!1)=>{if(!s||s?.nodeType==Node.TEXT_NODE)return;let i=":not(._mfld)",o=s.querySelectorAll(`[${u}${S.join(`]${i},[${u}`)}]${i}`);for(let i of(n?[...o]:[s,...o]).map((e=>((e,t)=>w.get(e)||new E("REGISTER ELEMENT FN",{element:e,ops:t}))(e,L)))){let s=p(structuredClone(L),i);for(let n of S)if(null!==i._(n))if("promote"!=n)for(let o of i._(n)?.split(";;")||[""]){let l=!!/get|head|post|put|delete|patch/.test(n),r=o?.split(/\s*->\s*/g),f=l&&r.pop()||"",a=l||"sync"==n?r.shift()?.match(/[^\(\)]{1,}/g)?.pop()?.split(h)?.map((e=>e.trim()))||[]:null,c=r?.[0]||"",{func:d,as:p,dependencyList:w}=$(c);if(i.I(d),a)for(let o of a)if("sync"==n){let s=s=>{d?.({$el:i.o,$st:t,$fn:e}),m(i,s)};"$mount"===o?s():i.D(o,s)}else T(i,o,s,f,n.replace(u,""),d);else"bind"==n?i.k(d,w):M(i,n,p||[],d,w||[],s)}else{let[e,t,n,o]="A"==i.o.tagName?["get",i.o.href,void 0,"click"]:[i.o.method?.toLowerCase(),i.o.action,()=>"$form","submit"];t&&T(i,o,s,t,e,n,(e=>v(e)))}}},A=["if","elseif","else","eval","each"];function N(s,n,i){let{func:o,as:r,dependencyList:f}=$(i||""),a=[],u=n.match(/if|else/);if(r=r||["$val","$key"],n.match(/else/)){let i=s,l=0;for(;i=i?.previousElementSibling;){let e="if";if(e=i.getAttribute("if")?"if":i.getAttribute("elseif")?"elseif":"",e&&a.push(i.U.get(e)?.name||""),l++>100){console.error("MFLD: Infinite loop detected");break}if(i.getAttribute("if"))break}f=[...f||[],...a],o=()=>{for(let e of a)if(t[e])return!1;return"else"==n||!0===o?.({$st:t,$fn:e})}}!function(e,t,s,n){let i=c(d(),{updater:()=>t?.({$el:e,$st:D,$fn:I}),dependencyList:s});n&&i.sub(n)}(s,o,f,(i=>{void 0!==i&&(u&&!i||l((()=>{for(let e of s.querySelectorAll(":not(template)"))y(e,"out",{},o);l((()=>{g("each"==n?i:[i],((n,i)=>{let o=s.G?.cloneNode(!0);if(!u){let s=o.innerHTML.replace(/\$:{([^}]*)}/g,((s,o)=>$(o,r[0],r[1]).func?.({$st:t,$fn:e,[r[0]]:n,[r[1]]:i})||""))||"";o.innerHTML&&(o.innerHTML=s)}for(let e of Array.from(o.content.children))e.innerHTML||(e.innerHTML=String(n)),s.append(e),y(e,"in",{})}))}))})))}))}class C extends HTMLElement{G=null;S=new Set;U=new Map;connectedCallback(){this.G=this.querySelector("template")||(()=>{let e=document.createElement("template");for(let t of this.children)e.content.appendChild(t);return e})();for(let e of A){let t=this.getAttribute(e);null!==t&&N(this,e,t)}}attributeChangedCallback(e,t,s){N(this,e,s)}disconnectedCallback(){for(let e of this.S)e=null}static get observedAttributes(){return A}}window.templ||(window.templ=customElements.define("mf-templ",C));let F={store:(e,t)=>(t?.hasOwnProperty("value")||t?.hasOwnProperty("updater")||(t={value:t}),c(e,t)),ustore:(e,t)=>c(e,t),funcs:e=>{for(let t in e)MFLD.$fn[t]=e[t]},config:(e,t)=>{return s=e,void((n=t)?L.profiles={...L.profiles,[n]:s}:L={...L,...s});var s,n},onTick:e=>{var t;(t=e)&&o.push(t)},register:e=>v("string"==typeof e?document.querySelector(e):e),makeComponent:(e,t)=>{MFLD.comp[e]=class extends HTMLElement{template=null;onconnect;onadopted;ondisconnect;onAttributeChanged;constructor(){super(),t?.onconstruct?.bind(this)?.(),this.onconnect=t?.onconnect?.bind(this),this.onadopted=t?.onadopted?.bind(this),this.ondisconnect=t?.ondisconnect?.bind(this),this.onAttributeChanged=t?.onAttributeChanged?.bind(this),this.template=new E("COMPONENT",{ops:t?.options||{},element:t?.templ||document.getElementById(t?.selector||e)})}connectedCallback(){let e=this.attachShadow({mode:t?.shadow||"closed"}),s=(this.template?.o).content.cloneNode(!0);if(s){e.append(s);for(let t of Array.from(e.children))if("SLOT"==t.nodeName)for(let e of t.assignedNodes())v(e);else"TEMPLATE"!=t.nodeName&&v(t)}}attributeChangedCallback(e,t,s){this.onAttributeChanged?.(e,t,s)}disconnectedCallback(){this.ondisconnect?.()}adoptedCallback(){this.onadopted?.()}static get observedAttributes(){return t?.observedAttributes||[]}},MFLD.comp[e]&&customElements.define(e,MFLD.comp[e])},component:async e=>{}},D=MFLD.$st,I=MFLD.$fn;export{I as $fn,D as $st,F as Mfld};
