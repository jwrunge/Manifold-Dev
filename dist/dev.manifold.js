window.MFLD||(window.MFLD={st:new Map,els:new Map,$st:l(),$fn:{},comp:{}});let e="mf-",t=/, {0,}/g,{$st:n,$fn:o}=window.MFLD,s=()=>`${Date.now()}_${Math.floor(1e5*Math.random())}`,i=(t,n)=>{let o=t.profiles?.[n.getAttribute("override")||""],s={...t,...o};for(let t in n?.attributes||[])for(let o of["fetch","trans"])if(t.startsWith(`${e}${o}_`))try{let e=t.split("_")[2],i=n.getAttribute(o);i?.match(/\{|\[/)?i=JSON.parse(i):parseInt(i||"")&&(i=parseInt(i)),Array.isArray(i)&&(i=i.map((e=>parseInt(e)||e))),s?.[o]?.[e]&&(s[o][e]=i)}catch(e){console.error(e)}return s};function l(e){return new Proxy(M,{get:(t,n)=>(e&&(n=e.find((e=>e.key==n))?.store||n),"string"==typeof n?t(n)?.value:void 0),set:(t,n,o)=>{if("string"==typeof n){let s=n.split(/[\.\[\]\?]{1,}/g).map((e=>parseFloat(e.trim())||e.trim()));e&&(s[0]=e.find((e=>e.key==s[0]))?.store||s[0]);let i=t(s[0]),l=i.value;for(let e of s.slice(1)||[])l=l[e];l=o,i.update(l)}return!0}})}window.MFLD.stProx||(window.MFLD.stProx=l);let r=(e,n=[],o=[])=>{try{let[s,i]=e?.split(/\s{1,}as\s{1,}/)||[e,"value"],l=o?`let $var = MFLD?.stProx?.(${JSON.stringify(o)});`:"",r=s?.match(/^\s{0,}(function)?\(.{0,}\)(=>)?\s{0,}/)?`(${s})()`:s,f=`let {$el,$st,$fn,$body${n?.length?","+n.join(","):""}}=ops;${l};return ${r}`,c=i?.split?.(t)?.map?.((e=>e.trim()))||["value"]||[],a=Array.from(new Set([...[...s?.matchAll(/\$st\.(\w{1,})/g)].map((e=>e[1])),...[...s?.matchAll(/\$var\.(\w{1,})/g)].map((e=>o.find((t=>t.key==e[1]))?.store||""))]));return console.log("FUNCTION",f),r?{func:new Function("ops",f),as:c,dependencyList:a}:{}}catch(e){return console.error(e),{}}};function f(e,t,n){t?.preventDefault();let o=e?.getAttribute("pushstate"),s=n;switch(o){case"":break;case void 0:return;default:s=`#${o}`}history.pushState(null,"",s)}function c(e,t,i,l){let r={$el:e,$st:n,$fn:o},f=M(s(),{updater:()=>t?.(r),dependencyList:i,internal:!0});return l&&f.sub(l),f}let a=[],u=new Set,d=0,h=[],p=e=>{e&&h.push(e)},$=e=>{"function"==typeof e?a.push(e):u.add(e),d||(d=requestAnimationFrame((()=>m())))};function m(e=0){if(e||console.log("%cRunning batched updates","background: yellow; color: red;",performance.now()),e>100)return void console.error("MFLD: Recursion limit reached - check for circular references.");d=0,e++;for(let e of a)e();let t=new Set;for(let e of u){let s=!1;for(let t of e.t)if(u.has(t)){s=!0;break}if(s)t.add(e);else{let t=e.o?.({$st:n,$fn:o,$el:e.i});e.update(void 0===t?e.value:t)}}a=[],u.clear(),t.size?(u=t,m(e)):(u.size&&m(e),h.forEach((e=>e())),h=[])}function w(e,t,n){$((()=>{n?.()}))}function y(e){if(!e||!isNaN(e)||!0===e)return e;if(e instanceof Map||e instanceof Set)return y(Array.from(e.entries()||e));let t=0;for(let n of(new TextEncoder).encode(e?.toString()||""))t=(t<<5)-t+n;return t}class g{o;l=new Set;u;t=new Set;h=new Set;i;name;value;constructor(e,t){this.name=e,MFLD.st.set(e,this),this.i=t?.scope,this.value="function"!=typeof t?.value?t?.value:void 0,this.p(t)}p(e){return e?.dependencyList?.map((e=>{let t=M(e);return this.t.add(t),t.h.add(this),t})),this.value=e?.value,this.o=e?.updater,$(this),this}sub(e,t=!0){this.l.add(e),t&&e(this.value)}update(e){setTimeout((()=>{let t="function"==typeof e?e(this.value):e,n=y(t);if(n!==this.u){this.value=t,this.u=n;for(let e of this.h)$(e);for(let e of Array.from(this.l))e(this.value)}}),0)}}function M(e,t){let n=MFLD.st.get(e);return t?n?n.p(t):new g(e,t):n||new g(e,t)}let b=(e,t,n,o,s,i,l)=>{let r=t=>L(t,s,n,o,null,e,!0,i,l);"$mount"===t?r():e.addListener(t,r)},S=(e,t,n,o)=>{let s=e.fetch?.externals?.find((e=>"$origin"===e.domain&&(t.startsWith(location.origin)||!t.match(/^(https?):\/\//))||t.startsWith(e.domain)));s||(s=t.startsWith(location.origin)?{domain:"$origin",script:"selected",style:"selected"}:void 0);let[i,l]=["style","script"].map((e=>Array.from(("all"==s?.[e]?n:o)?.querySelectorAll(e))));if("all"===s?.style)i.forEach((e=>o?.append(e)));else i.forEach((e=>e.parentNode?.removeChild(e)));for(let e of l)e.parentNode?.removeChild(e);return l},L=async(e,t,s,i,l,c,a,u,d)=>{e?.preventDefault();let h=u?u({$el:c,$st:n,$fn:o}):void 0,p="$form"===h?new FormData(c?.$):h,$=await fetch(i,{...s.fetch?.request||{},headers:{...s.fetch?.request?.headers,MFLD:"true"},method:t||e?.target?.method||"get",body:"$form"===h||"string"==typeof p?p:JSON.stringify(p)}).catch((e=>{s.fetch?.err?.(e)})),m=$?.status,y=await($?.[s.fetch?.resType||"text"]());if(m&&!1===s.fetch?.onCode?.(m,$))return;for(let e of l?[""]:["append","prepend","insert","replace"]){let t=l||c?.$?.getAttribute(e);if(null==t)continue;let[n,o]=t.split("->").map((e=>e.trim())),r=(new DOMParser).parseFromString(y,"text/html"),f=r.querySelector(n),u=S(s,i,r,f);if(f)if(a)w(0,0,(()=>{d?.(c);for(let e of u){let t=document.createElement("script");t.textContent=e.textContent,c?.$?.append(t)}})),c?.$&&w(o?c?.$?.querySelector(o):c.$);else{document.body.append(f);for(let e of u){let t=document.createElement("script");for(let n of e.attributes)t.setAttribute(n.name,n.value);t.textContent=e.textContent,f.before(t)}}}let g=c?.$?.getAttribute("resolve"),M=r(g||"")?.func;M?.({$el:c,$st:n,$fn:o,$body:y}),a&&f(c?.$,e,i)};class v{$=null;m=new Map;M=new Set;S=!1;L=new Set;constructor(e,t){this.$=e;for(let e of t||[])this.L.add(e);window.MFLD.els.set(e,this)}addListener(e,t){this.m.set(e,t),this.$?.addEventListener(e,t)}addInternalStore(e){this.M.add(e)}cleanUp(){this.m.forEach(((e,t)=>{this.$?.removeEventListener(t,e)})),this.$?.remove(),this.$=null}}let N={},T=["bind","sync","get","head","post","put","delete","patch","promote"],_=(e,t)=>{t?N.profiles={...N.profiles,[t]:e}:N={...N,...e}};window.addEventListener("popstate",(()=>{location.reload()}));let A=(s,l)=>{if(!s||s?.nodeType==Node.TEXT_NODE)return;let a=s.querySelectorAll(`[${e}${T.join(`],[${e}`)}]`);for(let u of l?.noparent?[...a]:[s,...a]){if(u!==s){let e=u.closest("._mf-component");if(e&&e!==s){console.log("SKIPPING REGISTRATION - registered in component",u);continue}}console.log("CONTINUING REGISTRATION",u);let a=window.MFLD.els.get(u)||new v(u,l?.fnCtx);if(a.S)continue;a.S=!0;let d=i(structuredClone(N),a.$);for(let s of a.$?.attributes||[]){if(!s.name.startsWith(e)||null===s.value)continue;let i=s.name.replace(e,"");if("promote"!=i)for(let e of a.$?.getAttribute(s.name)?.split(";;")||[""]){let l=!/bind|sync/.test(s.name),u=e?.split(/\s*->\s*/g),h=l&&u.pop()||"",p=l||"sync"==i?u.shift()?.match(/[^\(\)]{1,}/g)?.pop()?.split(t)?.map((e=>e.trim()))||[]:null,$=u?.[0]||"",{func:m,dependencyList:w}=r($,[],Array.from(a.L)||[]);if(p)for(let e of p)if("sync"==i){let t=e=>{m?.({$el:a.$,$st:n,$fn:o}),f(a.$,e)};"$mount"===e?t():a.$?.addEventListener(e,t)}else b(a,e,d,h,i,m);else console.log("HANDLING BIND",a.L),a.addInternalStore(c(a.$,m,w,void 0))}else{let[e,t,n,o]="A"==a.$?.tagName?["get",a.$.href,void 0,"click"]:[a.$.method?.toLowerCase(),a.$.action,()=>"$form","submit"];t&&b(a,o,d,t,e,n,(e=>A(e,{fnCtx:l?.fnCtx})))}}}};setTimeout((()=>A(document.body)),0);let I=(e,t)=>{MFLD.comp[e]||(MFLD.comp[e]=class extends HTMLElement{template=null;context=new Set;deps=new Set;onConnect;onAdopted;onDisconnect;onAttributeChanged;constructor(){super(),t?.onconstruct?.bind(this)?.(),this.onConnect=t?.onConnect?.bind(this),this.onAdopted=t?.onAdopted?.bind(this),this.onDisconnect=t?.onDisconnect?.bind(this),this.onAttributeChanged=t?.onAttributeChanged?.bind(this),this.template=document.getElementById(t?.selector||e)||document.createElement("template"),this.classList.contains("_mf-component")||this.classList.add("_mf-component")}connectedCallback(){let e=0!=t?.shadow?this.attachShadow({mode:t?.shadow||"closed"}):null,n=this.template.content.cloneNode(!0),o=this.parentNode?.closest("._mf-component");console.log("THIS",this,"CONTAINER",o),o&&(this.context=o?.context||new Map),console.log(o?.context||new Map);for(let e of this.attributes){if(["id","class","if","elseif","else","each"].includes(e.name))continue;let{func:t,dependencyList:n}=r(e.value,[],Array.from(this.context));if(t){for(let e of n||[])this.deps.add(e);for(let e of this.context)this.deps.add(e.store);console.log("REGISTERING WITH DEPS",this.deps);let o=c(this,t,Array.from(this.deps));this.context.add({key:e.name,store:o.name})}}if(console.log("CONSTRUCTING WITH CONTEXT",this.context),n){e?.append(n);for(let t of Array.from(e?.children||this.children))if("SLOT"==t.nodeName)for(let e of t.assignedNodes())A(e,{fnCtx:this.context});else"TEMPLATE"!=t.nodeName&&A(t,{fnCtx:this.context})}}attributeChangedCallback=this.onAttributeChanged;disconnectedCallback=this.onDisconnect;adoptedCallback=this.onAdopted;static get observedAttributes(){return t?.observedAttributes||[]}},MFLD.comp[e]&&customElements.define(e,MFLD.comp[e]))},C=["if","elseif","else","eval","each"],D="innerHTML",F=(e,t)=>{e[D]=t[D],t[D]=""};function k(e,t,s){let i,{func:l,as:f,dependencyList:a}=r(s||""),u=[],d=t.match(/if|else/);if(f=f||["$val","$key"],t.match(/else/)){let s=e,r=0;for(;s=s?.previousElementSibling;){let e="if";if(e=s.getAttribute("if")?"if":s.getAttribute("elseif")?"elseif":"",e&&u.push(s.M.get(e)?.name||""),r++>100){console.error("MFLD: No if start found");break}if(s.getAttribute("if"))break}a=[...a||[],...u],i=()=>{for(let e of u)if(n[e])return!1;return"else"==t||!0===l?.({$st:n,$fn:o})}}else i=l;let h=c(e,i,a,(s=>{if(void 0===s)return;let i=document.createElement("span");F(i,e),e.before(i),w(0,0,(()=>i.remove())),d&&!s||((e,t)=>{if(e instanceof Map)for(let[n,o]of e.entries())t(o,n);else try{let n=Array.isArray(e)?e:Array.from(e);if(n.length)n.forEach(t);else for(let n in e)t(e[n],n)}catch(t){console.error(`MFLD: ${e} is not iterable`)}})("each"==t?s:[s],((t,s)=>{let i=e.v?.cloneNode(!0);d||(i.innerHTML=i[D]?.replace(/{(\$[^}]*)}/g,((e,i)=>r(i,f.map((e=>`$${e}`))).func?.({$st:n,$fn:o,[`$${f[0]}`]:t,[`$${f[1]}`]:s})??""))||String(t)),e.append(i.content),w(0,0,(()=>A(e,{noparent:!0})))}))}));i&&e.N.add(i),e.M.set(t,h)}class E extends HTMLElement{v=null;N=new Set;M=new Map;connectedCallback(){this.v=this.querySelector("template")||(()=>{let e=document.createElement("template");return F(e,this),e})();let e="";for(let t of C){let n=this.getAttribute(t);null!=n&&(e&&console.error(`MFLD: Multiple templ statements '${e}' and '${t}'; '${e}' ignored`),e=t),null!==n&&k(this,t,n)}}disconnectedCallback(){this.N.forEach((e=>null))}static get observedAttributes(){return C}}window.templ||(window.templ=customElements.define("mf-templ",E));let x={make:(e,t)=>(t?.hasOwnProperty("value")||t?.hasOwnProperty("updater")||(t={value:t}),M(e,t)),untyped:(e,t)=>M(e,t),funcs:e=>{for(let t in e)MFLD.$fn[t]=e[t]}},O={make:I,register:async(e,t,n)=>{document.querySelectorAll(e).forEach((e=>e.classList.add("_mf-component"))),L(void 0,"get",{},t,"template -> body",null,!1).then((()=>{I(e,n)}))}};export{o as $fn,n as $st,O as component,_ as config,p as onTick,x as store};
//# sourceMappingURL=dev.manifold.js.map
