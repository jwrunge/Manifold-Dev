window.MFLD||(window.MFLD={st:new Map,els:new Map,$st:new Proxy(d,{get:(e,t)=>"string"==typeof t?e(t)?.value:void 0,set:(e,t,n)=>{if("string"==typeof t){let o=t.split(/[\.\[\]\?]{1,}/g).map((e=>parseFloat(e.trim())||e.trim())),s=e(o[0]),l=s.value;for(let e of o.slice(1)||[])l=l[e];l=n,s.update(l)}return!0}}),$fn:{},comp:{}});let{$fn:e,$st:t}=MFLD,n=[],o=new Set,s=0,l=[],i=e=>{e&&l.push(e)},r=e=>{"function"==typeof e?n.push(e):o.add(e),s||(s=requestAnimationFrame((()=>f())))};function f(i=0){if(i||console.log("%cRunning batched updates","background: yellow; color: red;",performance.now()),i>100)return void console.error("MFLD: Recursion limit reached - check for circular references.");s=0,i++;for(let e of n)e();let r=new Set;for(let n of o){let s=!1;for(let e of n.t)if(o.has(e)){s=!0;break}if(s)r.add(n);else{let o=n.o?.({$st:t,$fn:e,$el:n.l});n.update(void 0===o?n.value:o)}}n=[],o.clear(),r.size?(o=r,f(i)):(o.size&&f(i),l.forEach((e=>e())),l=[])}function c(e,t,n){r((()=>{n?.()}))}function a(e){if(!e||!isNaN(e)||!0===e)return e;if(e instanceof Map||e instanceof Set)return a(Array.from(e.entries()||e));let t=0;for(let n of(new TextEncoder).encode(e?.toString()||""))t=(t<<5)-t+n;return t}class u{o;i=new Set;u;t=new Set;h=new Set;l;name;value;constructor(e,t){this.name=e,MFLD.st.set(e,this),this.l=t?.scope,this.value="function"!=typeof t?.value?t?.value:void 0,this.p(t)}p(e){return e?.dependencyList?.map((e=>{let t=d(e);return this.t.add(t),t.h.add(this),t})),this.value=e?.value,this.o=e?.updater,r(this),this}sub(e,t=!0){this.i.add(e),t&&e(this.value)}update(e){setTimeout((()=>{let t="function"==typeof e?e(this.value):e,n=a(t);if(n!==this.u){this.value=t,this.u=n;for(let e of this.h)r(e);for(let e of Array.from(this.i))e(this.value)}}),0)}}function d(e,t){let n=MFLD.st.get(e);return t?n?n.p(t):new u(e,t):n||new u(e,t)}let h="mf-",p=/, {0,}/g,$=()=>`${Date.now()}.${Math.floor(1e5*Math.random())}`,m=(e,t)=>{let n=e.profiles?.[t.getAttribute("override")||""],o={...e,...n};for(let e in t?.attributes||[])for(let n of["fetch","trans"])if(e.startsWith(`${h}${n}_`))try{let s=e.split("_")[2],l=t.getAttribute(n);l?.match(/\{|\[/)?l=JSON.parse(l):parseInt(l||"")&&(l=parseInt(l)),Array.isArray(l)&&(l=l.map((e=>parseInt(e)||e))),o?.[n]?.[s]&&(o[n][s]=l)}catch(e){console.error(e)}return o},y=(e,t=[],n=[])=>{try{let[o,s]=e?.split(/\s{1,}as\s{1,}/)||[e,"value"],l=n?.map?.((e=>`let $${e.key}=$st["${e.store.name}"]; console.log($${e.key})`))?.join(";")||"",i=o?.match(/^\s{0,}(function)?\(.{0,}\)(=>)?\s{0,}/)?`(${o})()`:o,r=`console.log(ops);let {$el,$st,$fn,$body${t?.length?","+t.join(","):""}}=ops;${l};return ${i}`,f=s?.split?.(p)?.map?.((e=>e.trim()))||["value"]||[],c=Array.from(new Set([...o?.matchAll(/\$st\.(\w{1,})/g)].map((e=>e[1]))));return console.log("FUNCTION TEXT",l,r),i?{func:new Function("ops",r),as:f,dependencyList:c}:{}}catch(e){return console.error(e),{}}};function w(e,t,n){t?.preventDefault();let o=e?.getAttribute("pushstate"),s=n;switch(o){case"":break;case void 0:return;default:s=`#${o}`}history.pushState(null,"",s)}function g(n,o,s,l,i){let r={$el:n,$st:t,$fn:e},f=d($(),{updater:()=>o?.(r),dependencyList:[...s||[],...(i||[]).map((e=>e.store.name))],internal:!0});return l&&f.sub(l),f}let b=(e,t,n,o,s,l,i)=>{let r=t=>L(t,s,n,o,null,e,!0,l,i);"$mount"===t?r():e.addListener(t,r)},M=(e,t,n,o)=>{let s=e.fetch?.externals?.find((e=>"$origin"===e.domain&&(t.startsWith(location.origin)||!t.match(/^(https?):\/\//))||t.startsWith(e.domain)));s||(s=t.startsWith(location.origin)?{domain:"$origin",script:"selected",style:"selected"}:void 0);let[l,i]=["style","script"].map((e=>Array.from(("all"==s?.[e]?n:o)?.querySelectorAll(e))));if("all"===s?.style)l.forEach((e=>o?.append(e)));else l.forEach((e=>e.parentNode?.removeChild(e)));for(let e of i)e.parentNode?.removeChild(e);return i},L=async(n,o,s,l,i,r,f,a,u)=>{n?.preventDefault();let d=a?a({$el:r,$st:t,$fn:e}):void 0,h="$form"===d?new FormData(r?.$):d,p=await fetch(l,{...s.fetch?.request||{},headers:{...s.fetch?.request?.headers,MFLD:"true"},method:o||n?.target?.method||"get",body:"$form"===d||"string"==typeof h?h:JSON.stringify(h)}).catch((e=>{s.fetch?.err?.(e)})),$=p?.status,m=await(p?.[s.fetch?.resType||"text"]());if($&&!1===s.fetch?.onCode?.($,p))return;for(let e of i?[""]:["append","prepend","insert","replace"]){let t=i||r?.$?.getAttribute(e);if(null==t)continue;let[n,o]=t.split("->").map((e=>e.trim())),a=(new DOMParser).parseFromString(m,"text/html"),d=a.querySelector(n),h=M(s,l,a,d);if(d)if(f)c(0,0,(()=>{u?.(r);for(let e of h){let t=document.createElement("script");t.textContent=e.textContent,r?.$?.append(t)}})),r?.$&&c(o?r?.$?.querySelector(o):r.$);else{document.body.append(d);for(let e of h){let t=document.createElement("script");for(let n of e.attributes)t.setAttribute(n.name,n.value);t.textContent=e.textContent,d.before(t)}}}let g=r?.$?.getAttribute("resolve"),b=y(g||"")?.func;b?.({$el:r,$st:t,$fn:e,$body:m}),f&&w(r?.$,n,l)};class v{$=null;m=new Map;M=new Set;L=!1;v=new Set;constructor(e,t){this.$=e;for(let e of t||[])this.v.add(e);window.MFLD.els.set(e,this)}addListener(e,t){this.m.set(e,t),this.$?.addEventListener(e,t)}addInternalStore(e){this.M.add(e)}cleanUp(){this.m.forEach(((e,t)=>{this.$?.removeEventListener(t,e)})),this.$?.remove(),this.$=null}}let _={},A=["bind","sync","get","head","post","put","delete","patch","promote"],F=(e,t)=>{t?_.profiles={..._.profiles,[t]:e}:_={..._,...e}};window.addEventListener("popstate",(()=>{location.reload()}));let S=(n,o)=>{if(!n||n?.nodeType==Node.TEXT_NODE)return;let s=n.querySelectorAll(`[${h}${A.join(`],[${h}`)}]`);for(let l of(o?.noparent?[...s]:[n,...s]).filter((e=>{if(e===n)return!0;let t=e.closest("._mf-component");return!t||t===n})).map((e=>window.MFLD.els.get(e)||new v(e,o?.fnCtx)))){if(l.L)continue;l.L=!0;let n=m(structuredClone(_),l.$);for(let s of l.$?.attributes||[]){if(!s.name.startsWith(h)||null===s.value)continue;let i=s.name.replace(h,"");if("promote"!=i)for(let o of l.$?.getAttribute(s.name)?.split(";;")||[""]){let r=!/bind|sync/.test(s.name),f=o?.split(/\s*->\s*/g),c=r&&f.pop()||"",a=r||"sync"==i?f.shift()?.match(/[^\(\)]{1,}/g)?.pop()?.split(p)?.map((e=>e.trim()))||[]:null,u=f?.[0]||"",{func:d,dependencyList:h}=y(u,[],Array.from(l.v)||[]);if(a)for(let o of a)if("sync"==i){let n=n=>{d?.({$el:l.$,$st:t,$fn:e}),w(l.$,n)};"$mount"===o?n():l.$?.addEventListener(o,n)}else b(l,o,n,c,i,d);else l.addInternalStore(g(l.$,d,h,void 0,Array.from(l.v)))}else{let[e,t,s,i]="A"==l.$?.tagName?["get",l.$.href,void 0,"click"]:[l.$.method?.toLowerCase(),l.$.action,()=>"$form","submit"];t&&b(l,i,n,t,e,s,(e=>S(e,{fnCtx:o?.fnCtx})))}}}};setTimeout((()=>S(document.body)),0);let k=(e,t)=>{MFLD.comp[e]||(MFLD.comp[e]=class extends HTMLElement{template=null;context=[];deps=new Set;onConnect;onAdopted;onDisconnect;onAttributeChanged;constructor(){super(),t?.onconstruct?.bind(this)?.(),this.onConnect=t?.onConnect?.bind(this),this.onAdopted=t?.onAdopted?.bind(this),this.onDisconnect=t?.onDisconnect?.bind(this),this.onAttributeChanged=t?.onAttributeChanged?.bind(this),this.template=document.getElementById(t?.selector||e)||document.createElement("template"),this.classList.contains("_mf-component")||this.classList.add("_mf-component")}connectedCallback(){let e=this.attachShadow({mode:t?.shadow||"closed"}),n=this.template.content.cloneNode(!0);for(let e of this.attributes){if(["id","class"].includes(e.name))continue;let{func:t,dependencyList:n}=y(e.value);if(t){for(let e of n||[])this.deps.add(e);let o=g(this,t,Array.from(this.deps));this.context.push({key:e.name,store:o})}}if(n){e.append(n);for(let t of Array.from(e.children))if("SLOT"==t.nodeName)for(let e of t.assignedNodes())S(e,{fnCtx:this.context});else"TEMPLATE"!=t.nodeName&&S(t,{fnCtx:this.context})}}attributeChangedCallback=this.onAttributeChanged;disconnectedCallback=this.onDisconnect;adoptedCallback=this.onAdopted;static get observedAttributes(){return t?.observedAttributes||[]}},MFLD.comp[e]&&customElements.define(e,MFLD.comp[e]))},D=["if","elseif","else","eval","each"],C="innerHTML",x=(e,t)=>{e[C]=t[C],t[C]=""};function T(n,o,s){let l,{func:i,as:r,dependencyList:f}=y(s||""),a=[],u=o.match(/if|else/);if(r=r||["$val","$key"],o.match(/else/)){let s=n,r=0;for(;s=s?.previousElementSibling;){let e="if";if(e=s.getAttribute("if")?"if":s.getAttribute("elseif")?"elseif":"",e&&a.push(s.M.get(e)?.name||""),r++>100){console.error("MFLD: No if start found");break}if(s.getAttribute("if"))break}f=[...f||[],...a],l=()=>{for(let e of a)if(t[e])return!1;return"else"==o||!0===i?.({$st:t,$fn:e})}}else l=i;let d=g(n,l,f,(s=>{if(void 0===s)return;let l=document.createElement("span");x(l,n),n.before(l),c(0,0,(()=>l.remove())),u&&!s||((e,t)=>{if(e instanceof Map)for(let[n,o]of e.entries())t(o,n);else try{let n=Array.isArray(e)?e:Array.from(e);if(n.length)n.forEach(t);else for(let n in e)t(e[n],n)}catch(t){console.error(`MFLD: ${e} is not iterable`)}})("each"==o?s:[s],((o,s)=>{let l=n._?.cloneNode(!0);u||(l.innerHTML=l[C]?.replace(/{(\$[^}]*)}/g,((n,l)=>y(l,r.map((e=>`$${e}`))).func?.({$st:t,$fn:e,[`$${r[0]}`]:o,[`$${r[1]}`]:s})??""))||String(o)),n.append(l.content),c(0,0,(()=>S(n,{noparent:!0})))}))}));l&&n.A.add(l),n.M.set(o,d)}class E extends HTMLElement{_=null;A=new Set;M=new Map;connectedCallback(){this._=this.querySelector("template")||(()=>{let e=document.createElement("template");return x(e,this),e})();let e="";for(let t of D){let n=this.getAttribute(t);null!=n&&(e&&console.error(`MFLD: Multiple templ statements '${e}' and '${t}'; '${e}' ignored`),e=t),null!==n&&T(this,t,n)}}disconnectedCallback(){this.A.forEach((e=>null))}static get observedAttributes(){return D}}window.templ||(window.templ=customElements.define("mf-templ",E));let N={make:(e,t)=>(t?.hasOwnProperty("value")||t?.hasOwnProperty("updater")||(t={value:t}),d(e,t)),untyped:(e,t)=>d(e,t),funcs:e=>{for(let t in e)MFLD.$fn[t]=e[t]}},I={make:k,register:async(e,t,n)=>{document.querySelectorAll(e).forEach((e=>e.classList.add("_mf-component"))),L(void 0,"get",{},t,"template -> body",null,!1).then((()=>{k(e,n)}))}};export{e as $fn,t as $st,I as component,F as config,i as onTick,N as store};
//# sourceMappingURL=dev.manifold.js.map
