<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Manifold Registry Test</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				max-width: 800px;
				margin: 0 auto;
				padding: 20px;
			}
			.test-section {
				margin: 20px 0;
				padding: 15px;
				border: 1px solid #ccc;
				border-radius: 5px;
			}
			.hidden {
				display: none;
			}
			.item {
				padding: 8px;
				margin: 4px 0;
				background: #f0f0f0;
				border-radius: 3px;
			}
			button {
				padding: 8px 16px;
				margin: 5px;
				background: #007acc;
				color: white;
				border: none;
				border-radius: 3px;
				cursor: pointer;
			}
			button:hover {
				background: #005999;
			}
			input {
				padding: 5px;
				margin: 5px;
				border: 1px solid #ccc;
				border-radius: 3px;
			}
		</style>
	</head>
	<body>
		<h1>Registry Test - data-scope</h1>

		<div class="test-section">
			<h2>Computed State Example</h2>
			<p>
				Demonstrates the new computed() helper function for reactive
				derived values
			</p>
			<div data-bind="textContent: @greeting">${greeting}</div>
			<p>
				Try changing the user name or age below to see the greeting
				update automatically!
			</p>
		</div>

		<span id="test-el-2" data-bind="textContent: 'Counter is ' + @counter">
			Counter is ${counter}!
		</span>

		<div id="test-el-3" data-scope="@counter as count" data-if="@count > 5">
			Counter (aliased as count) is greater than 5:
			<span id="counter-display"></span>
		</div>
		<div
			id="test-el-44"
			data-scope="@counter as count"
			data-elseif="@count > 1"
		>
			Counter (aliased as count) is greater than 1 BOI:
			<span id="counter-display"></span>
		</div>
		<div id="test-el-55" data-scope="@counter as count" data-else>
			Counter (aliased as count) is 0 or 1 or something really low:
			<span id="counter-display"></span>
		</div>

		<div id="test-el-4" data-scope="@user.name as name">
			User name (aliased): <span data-bind="textContent: @name"></span> ==
			${name}
		</div>

		<div class="test-section">
			<h2>Data-Sync Test (Two-Way Binding)</h2>
			<p>Testing data-sync for bidirectional state binding</p>

			<!-- Text input sync -->
			<div>
				<label>Text Input (synced with @user.name):</label>
				<input
					type="text"
					id="name-input"
					data-sync="value:@user.name"
					placeholder="Enter name"
				/>
				<p>
					Current user name:
					<span data-bind="textContent:@user.name"></span>
				</p>
			</div>

			<!-- Number input sync -->
			<div>
				<label>Number Input (synced with @user.age):</label>
				<input
					type="number"
					id="age-input"
					data-sync="value:@user.age"
					min="0"
					max="120"
				/>
				<p>
					Current user age:
					<span data-bind="textContent:@user.age"></span>
				</p>
			</div>

			<!-- Checkbox sync -->
			<div>
				<label>
					<input
						type="checkbox"
						id="active-checkbox"
						data-sync="checked:@user.active"
					/>
					User is active
				</label>
				<p>
					Active status:
					<span data-bind="textContent:@user.active"></span>
				</p>
			</div>

			<!-- Counter with aliasing -->
			<div data-scope="@counter as count">
				<label>Counter Input (with aliasing):</label>
				<input
					type="number"
					id="counter-input"
					data-sync="value:@count"
				/>
				<p>
					Counter value: <span data-bind="textContent:@count"></span>
				</p>
			</div>

			<button onclick="resetSyncTest()">Reset Values</button>
			<button onclick="logSyncValues()">Log Current Values</button>
		</div>

		<div class="test-section">
			<h2>Data-Each Test (List Rendering)</h2>
			<p>Testing data-each for efficient list rendering with aliasing</p>

			<!-- Simple list -->
			<div>
				<h3>Todo List (@todos as todo, index):</h3>
				<ul>
					<li
						data-each="@todos as todo, index"
						data-bind="textContent: @index + ': ' + @todo.text + ' (' + (@todo.done ? 'done' : 'pending') + ')'"
					></li>
				</ul>
			</div>

			<!-- Interactive list -->
			<div>
				<h3>Numbers List (@numbers as num):</h3>
				<div>
					<span
						data-each="@numbers as num"
						data-bind="textContent: 'Number: ' + @num + ', '"
					></span>
					<br />
				</div>
			</div>

			<button onclick="addTodo()">Add Todo</button>
			<button onclick="toggleFirstTodo()">Toggle First Todo</button>
			<button onclick="addNumber()">Add Random Number</button>
			<button onclick="clearNumbers()">Clear Numbers</button>
			<button onclick="debugDataEach()">Debug Data-Each</button>
			<button onclick="testExpression()">Test Expression</button>
		</div>

		<div class="test-section">
			<h2>Element Registry Test</h2>
			<p>Testing data-scope prop binding and logging</p>

			<div
				id="test-element"
				data-if="@user as me !== undefined"
				data-scope="@user, @counter as count"
			>
				Test element with scoped props
			</div>

			<button onclick="logProps()">Log Props</button>
			<button onclick="updateProps()">Update Props</button>
			<button onclick="logPropsAgain()">Log Props Again</button>
			<button onclick="incrementCounter()">Increment Counter</button>
		</div>

		<!-- Import Manifold -->
		<script type="module">
			import { State, computed } from "./src/State.js";
			import { RegEl } from "./src/registry.js";
			import { evaluateExpression } from "./src/expression-parser.js";

			// Initialize test states
			window.userState = new State(
				{
					name: "John Doe",
					age: 25,
					active: false,
				},
				"user"
			);
			window.counterState = new State(0, "counter");

			// Create a computed state that derives from user state
			window.greetingState = computed(() => {
				const user = window.userState.value;
				return `Hello, ${user.name}! You are ${user.age} years old.`;
			});

			// Initialize array states for data-each testing
			window.todosState = new State(
				[
					{ text: "Learn Manifold", done: false },
					{ text: "Build awesome apps", done: false },
					{ text: "Celebrate success", done: true },
				],
				"todos"
			);

			window.numbersState = new State([1, 2, 3, 4, 5], "numbers");

			// Register states globally
			State.register("user", window.userState);
			State.register("counter", window.counterState);
			State.register("todos", window.todosState);
			State.register("numbers", window.numbersState);
			State.register("greeting", window.greetingState);

			// Debug: Log available states
			console.log("=== REGISTERED STATES ===");
			console.log("User state:", State.get("user"));
			console.log("Counter state:", State.get("counter"));
			console.log("Todos state:", State.get("todos"));
			console.log("Numbers state:", State.get("numbers"));
			console.log("Todos value:", window.todosState.value);
			console.log("Numbers value:", window.numbersState.value);

			// Register the test element
			let testRegEl;
			document.addEventListener("DOMContentLoaded", () => {
				const testElement = document.getElementById("test-element");
				testRegEl = RegEl.register(testElement);

				const testElement2 = document.getElementById("test-el-2");
				RegEl.register(testElement2);
				const testElement3 = document.getElementById("test-el-3");
				RegEl.register(testElement3);

				const testElement4 = document.getElementById("test-el-4");
				RegEl.register(testElement4);
				const testElement44 = document.getElementById("test-el-44");
				RegEl.register(testElement44);

				const testElement55 = document.getElementById("test-el-55");
				RegEl.register(testElement55);

				// Register sync test elements
				const nameInput = document.getElementById("name-input");
				RegEl.register(nameInput);

				const ageInput = document.getElementById("age-input");
				RegEl.register(ageInput);

				const activeCheckbox =
					document.getElementById("active-checkbox");
				RegEl.register(activeCheckbox);

				// Register the counter scope div first, then the input
				const counterScopeDiv = document.querySelector(
					'.test-section [data-scope="@counter as count"]'
				);
				console.log("=== REGISTERING COUNTER SCOPE DIV ===");
				console.log("Counter scope div:", counterScopeDiv);
				if (counterScopeDiv) {
					const scopeRegEl = RegEl.register(counterScopeDiv);
					console.log("Scope RegEl props:", scopeRegEl.props);
				}

				console.log("=== REGISTERING COUNTER INPUT ===");
				const counterInput = document.getElementById("counter-input");
				console.log("Counter input:", counterInput);
				console.log(
					"Counter input parent:",
					counterInput.parentElement
				);
				const inputRegEl = RegEl.register(counterInput);
				console.log("Input RegEl props:", inputRegEl.props);

				// Register display spans for sync test
				const nameDisplay = document.querySelector(
					'[data-bind="textContent:@user.name"]'
				);
				if (nameDisplay) RegEl.register(nameDisplay);

				const ageDisplay = document.querySelector(
					'[data-bind="textContent:@user.age"]'
				);
				if (ageDisplay) RegEl.register(ageDisplay);

				const activeDisplay = document.querySelector(
					'[data-bind="textContent:@user.active"]'
				);
				if (activeDisplay) RegEl.register(activeDisplay);

				const countDisplay = document.querySelector(
					'[data-bind="textContent:@count"]'
				);
				if (countDisplay) RegEl.register(countDisplay);

				// Register data-each elements (the repeating elements, not their containers)
				const todoListItem = document.querySelector(
					'li[data-each="@todos as todo, index"]'
				);
				console.log("Todo list item element:", todoListItem);
				if (todoListItem) {
					console.log("Registering todo list item...");
					const todosRegEl = RegEl.register(todoListItem);
					console.log("Todo item RegEl:", todosRegEl);
					console.log("Todo item RegEl props:", todosRegEl.props);
				}

				const numbersSpan = document.querySelector(
					'span[data-each="@numbers as num"]'
				);
				console.log("Numbers span element:", numbersSpan);
				if (numbersSpan) {
					console.log("Registering numbers span...");
					const numbersRegEl = RegEl.register(numbersSpan);
					console.log("Numbers span RegEl:", numbersRegEl);
					console.log(
						"Numbers span RegEl props:",
						numbersRegEl.props
					);
				}

				console.log("Element registered:", testRegEl);
			});

			// Test functions
			window.logProps = () => {
				console.log("=== Logging Props ===");
				console.log("RegEl props:", testRegEl.props);

				Object.entries(testRegEl.props).forEach(([key, state]) => {
					console.log(`${key}:`, state.value);
				});
			};

			window.updateProps = () => {
				console.log("=== Updating Props ===");
				window.userState.value = {
					name: "Jane Smith",
					age: 30,
				};
				window.counterState.value = 42;
				console.log("Props updated!");
			};

			window.logPropsAgain = () => {
				console.log("=== Logging Props Again ===");
				console.log("RegEl props:", testRegEl.props);

				Object.entries(testRegEl.props).forEach(([key, state]) => {
					console.log(`${key}:`, state.value);
				});
			};

			window.incrementCounter = () => {
				console.log("=== Incrementing Counter ===");
				window.counterState.value += 1;
				console.log("Counter is now:", window.counterState.value);
			};

			window.resetSyncTest = () => {
				console.log("=== Resetting Sync Test Values ===");
				window.userState.value = {
					name: "John Doe",
					age: 25,
					active: false,
				};
				window.counterState.value = 0;
				console.log("Values reset!");
			};

			window.logSyncValues = () => {
				console.log("=== Current Sync Values ===");
				console.log("User state:", window.userState.value);
				console.log("Counter state:", window.counterState.value);

				// Also log the actual DOM element values
				console.log("DOM Element Values:");
				console.log(
					"Name input:",
					document.getElementById("name-input").value
				);
				console.log(
					"Age input:",
					document.getElementById("age-input").value
				);
				console.log(
					"Active checkbox:",
					document.getElementById("active-checkbox").checked
				);
				console.log(
					"Counter input:",
					document.getElementById("counter-input").value
				);

				// Debug: Check if the alias states are the same objects
				const counterInputRegEl = RegEl.getRegEl(
					document.getElementById("counter-input")
				);
				if (counterInputRegEl) {
					console.log("=== Counter Input RegEl Props ===");
					console.log("Props:", counterInputRegEl.props);
					console.log("count state:", counterInputRegEl.props.count);
					console.log(
						"counter state:",
						counterInputRegEl.props.counter
					);
					console.log(
						"Are they the same object?",
						counterInputRegEl.props.count ===
							counterInputRegEl.props.counter
					);
					console.log(
						"count value:",
						counterInputRegEl.props.count?.value
					);
					console.log(
						"counter value:",
						counterInputRegEl.props.counter?.value
					);
				}
			};

			window.debugSync = () => {
				console.log("=== SYNC DEBUG ===");
				const counterInput = document.getElementById("counter-input");
				const regEl = RegEl.getRegEl(counterInput);
				console.log("Counter input element:", counterInput);
				console.log("Counter input RegEl:", regEl);
				console.log("Counter input value:", counterInput.value);
				console.log("Counter state value:", window.counterState.value);
				console.log(
					"Available aliases in props:",
					regEl ? Object.keys(regEl.props) : "No RegEl"
				);
				if (regEl) {
					console.log("count alias state:", regEl.props.count);
					console.log("count alias value:", regEl.props.count?.value);
					console.log("counter alias state:", regEl.props.counter);
					console.log(
						"counter alias value:",
						regEl.props.counter?.value
					);
				}

				// Test manual sync
				console.log("=== TESTING MANUAL SYNC ===");
				if (regEl && regEl.props.count) {
					console.log("Setting count state to 99");
					regEl.props.count.value = 99;
					console.log(
						"Count state after manual set:",
						regEl.props.count.value
					);
					console.log(
						"Global counter state:",
						window.counterState.value
					);
				}
			};

			// Data-each test functions
			window.addTodo = () => {
				console.log("=== Adding Todo ===");
				const newTodo = {
					text: `New todo ${window.todosState.value.length + 1}`,
					done: false,
				};
				window.todosState.value = [...window.todosState.value, newTodo];
				console.log("New todos:", window.todosState.value);
			};

			window.toggleFirstTodo = () => {
				console.log("=== Toggling First Todo ===");
				const todos = [...window.todosState.value];
				if (todos.length > 0) {
					todos[0] = { ...todos[0], done: !todos[0].done };
					window.todosState.value = todos;
					console.log("Updated todos:", window.todosState.value);
				}
			};

			window.addNumber = () => {
				console.log("=== Adding Random Number ===");
				const randomNum = Math.floor(Math.random() * 100);
				window.numbersState.value = [
					...window.numbersState.value,
					randomNum,
				];
				console.log("New numbers:", window.numbersState.value);
			};

			window.clearNumbers = () => {
				console.log("=== Clearing Numbers ===");
				window.numbersState.value = [];
				console.log("Numbers cleared");
			};

			window.debugDataEach = () => {
				console.log("=== DEBUG DATA-EACH ===");
				const todoListItem = document.querySelector(
					'li[data-each="@todos as todo, index"]'
				);
				const numbersSpan = document.querySelector(
					'span[data-each="@numbers as num"]'
				);

				console.log("Todo list item element:", todoListItem);
				console.log("Numbers span element:", numbersSpan);

				if (todoListItem) {
					const todosRegEl = RegEl.getRegEl(todoListItem);
					console.log("Todo item RegEl:", todosRegEl);
					console.log("Todo item each state:", todosRegEl?.each);
					console.log(
						"Todo item each value:",
						todosRegEl?.each?.value
					);
				}

				if (numbersSpan) {
					const numbersRegEl = RegEl.getRegEl(numbersSpan);
					console.log("Numbers span RegEl:", numbersRegEl);
					console.log("Numbers span each state:", numbersRegEl?.each);
					console.log(
						"Numbers span each value:",
						numbersRegEl?.each?.value
					);
				}

				console.log("Global todos state:", window.todosState.value);
				console.log("Global numbers state:", window.numbersState.value);
			};

			window.testExpression = () => {
				console.log("=== TESTING EXPRESSION ===");

				// Test simple expressions first
				console.log("--- Simple expressions ---");
				let expr1 = "@index";
				let evaluator1 = evaluateExpression(expr1);
				console.log(`${expr1} ->`, evaluator1.fn({ index: 0 }));

				let expr2 = "': '";
				let evaluator2 = evaluateExpression(expr2);
				console.log(`${expr2} ->`, evaluator2.fn({}));

				let expr3 = "@index + ': '";
				let evaluator3 = evaluateExpression(expr3);
				console.log(`${expr3} ->`, evaluator3.fn({ index: 0 }));

				// Test the problematic numbers expression
				console.log("--- Problematic numbers expression ---");
				let expr4 = "'Number: ' + @num + ', '";
				let evaluator4 = evaluateExpression(expr4);
				console.log(`${expr4} ->`, evaluator4.fn({ num: 42 }));

				// Test the exact expression used in the todo list
				console.log("--- Complex expression ---");
				const expr =
					"@index + ': ' + @todo.text + ' (' + (@todo.done ? 'done' : 'pending') + ')'";
				console.log("Expression:", expr);

				const evaluator = evaluateExpression(expr);
				console.log("Evaluator:", evaluator);

				// Test with sample context
				const context = {
					index: 0,
					todo: { text: "Test todo", done: false },
				};
				console.log("Context:", context);

				const result = evaluator.fn(context);
				console.log("Result:", result);
			};
		</script>
	</body>
</html>
