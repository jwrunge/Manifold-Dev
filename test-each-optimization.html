<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Test Each Loop Optimization</title>
		<script type="module">
			import Manifold from "./src/index.ts";

			// Initialize Manifold
			const { watch, init, State } = Manifold;

			// Create state with todo items
			const todos = watch([
				{ id: 1, text: "Learn Manifold", done: false },
				{ id: 2, text: "Build awesome app", done: false },
				{ id: 3, text: "Deploy to production", done: false },
			]);

			// Register the state so RegEl can find it
			State.register("todos", todos);

			// Make states globally available
			window.todos = todos;

			// Add some testing functions
			window.addTodo = () => {
				const newId = Date.now();
				todos.value = [
					...todos.value,
					{ id: newId, text: `New todo ${newId}`, done: false },
				];
			};

			window.removeTodo = () => {
				if (todos.value.length > 0) {
					todos.value = todos.value.slice(0, -1);
				}
			};

			window.toggleFirst = () => {
				if (todos.value.length > 0) {
					const updated = [...todos.value];
					updated[0] = { ...updated[0], done: !updated[0].done };
					todos.value = updated;
				}
			};

			window.updateFirst = () => {
				if (todos.value.length > 0) {
					const updated = [...todos.value];
					updated[0] = {
						...updated[0],
						text: `Updated at ${new Date().toLocaleTimeString()}`,
					};
					todos.value = updated;
				}
			};

			// Test reordering
			window.moveFirstToEnd = () => {
				if (todos.value.length > 1) {
					const [first, ...rest] = todos.value;
					todos.value = [...rest, first];
				}
			};

			console.log("Manifold initialized. Available functions:");
			console.log("- addTodo(): Add a new todo");
			console.log("- removeTodo(): Remove the last todo");
			console.log(
				"- toggleFirst(): Toggle the done status of the first todo"
			);
			console.log("- updateFirst(): Update the text of the first todo");
			console.log("- moveFirstToEnd(): Move the first todo to the end");

			// Initialize Manifold to process data attributes
			init();
		</script>
		<style>
			body {
				font-family: Arial, sans-serif;
				max-width: 800px;
				margin: 0 auto;
				padding: 20px;
			}

			.todo-item {
				background: #f5f5f5;
				margin: 10px 0;
				padding: 15px;
				border-radius: 8px;
				border-left: 4px solid #007acc;
				transition: all 0.3s ease;
			}

			.todo-item.done {
				border-left-color: #28a745;
				opacity: 0.7;
			}

			.controls {
				margin: 20px 0;
				padding: 20px;
				background: #e9ecef;
				border-radius: 8px;
			}

			button {
				margin: 5px;
				padding: 10px 15px;
				border: none;
				border-radius: 4px;
				background: #007acc;
				color: white;
				cursor: pointer;
			}

			button:hover {
				background: #0056b3;
			}

			.instructions {
				background: #d1ecf1;
				padding: 15px;
				border-radius: 8px;
				margin-bottom: 20px;
				border: 1px solid #bee5eb;
			}
		</style>
	</head>
	<body>
		<h1>Manifold Each Loop Optimization Test</h1>

		<div class="instructions">
			<h3>Testing Instructions:</h3>
			<p>
				This page tests the efficient
				<code>data-each</code> implementation. Open the browser
				developer tools and watch the console for DOM operations. The
				system should only update elements that actually change, not
				recreate everything.
			</p>
			<p><strong>Expected behavior:</strong></p>
			<ul>
				<li>
					<strong>Add/Remove:</strong> Only new elements created or
					removed, existing ones stay unchanged
				</li>
				<li>
					<strong>Update First:</strong> Only the first element's
					content changes, others stay untouched
				</li>
				<li>
					<strong>Toggle First:</strong> Only the first element's
					styling changes
				</li>
				<li>
					<strong>Reorder:</strong> DOM elements move efficiently
					without recreating content
				</li>
			</ul>
		</div>

		<div class="controls">
			<h3>Test Controls:</h3>
			<button onclick="addTodo()">Add Todo</button>
			<button onclick="removeTodo()">Remove Todo</button>
			<button onclick="toggleFirst()">Toggle First Done</button>
			<button onclick="updateFirst()">Update First Text</button>
			<button onclick="moveFirstToEnd()">Move First to End</button>
		</div>

		<div id="todo-list">
			<h3>Todo List:</h3>

			<!-- Each loop template -->
			<div
				data-each="@todos as todo, index"
				data-bind="className: @todo.done ? 'todo-item done' : 'todo-item'"
			>
				<div
					data-bind="textContent: (@index + 1) + '. ' + @todo.text"
				></div>
				<div
					data-bind="textContent: 'Status: ' + (@todo.done ? 'Done ✓' : 'Pending ⏳')"
				></div>
				<div
					data-bind="textContent: 'ID: ' + @todo.id"
					style="font-size: 0.8em; color: #666"
				></div>
			</div>
		</div>

		<div
			style="
				margin-top: 40px;
				padding: 20px;
				background: #f8f9fa;
				border-radius: 8px;
			"
		>
			<h3>Debug Info:</h3>
			<p>
				Open browser developer tools to see console logs showing the
				efficient DOM operations.
			</p>
			<p>
				Each operation should only log minimal DOM changes rather than
				recreating all elements.
			</p>
		</div>
	</body>
</html>
